<!DOCTYPE html>
<html lang="it" id="htmlRoot">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MindStep">
<meta name="theme-color" content="#00d4ff">
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icon-512.png">
<title>MindStep ‚Äî AI Walking Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --n:#0a1128;--n2:#1a2357;--n3:#2b3a7f;--n4:#3b4fa0;
  --c:#00d4ff;--c2:#33ddff;--c3:#5ce1e6;
  --bg:#f8f9fa;--card:#ffffff;--bdr:#e5e7eb;
  --tx:#0f1419;--tx2:#6b7280;--tx3:#9ca3af;
  --gr:linear-gradient(135deg,#00d4ff,#5ce1e6);
  --grd:linear-gradient(135deg,#3b4fa0,#00d4ff);
  --sh:0 1px 4px rgba(15,20,25,.08);
  --r:12px;--t:220ms cubic-bezier(.4,0,.2,1);
  /* RING colors */
  --ring1:#00d4ff;--ring2:#7c3aed;--ring3:#10b981
}
[data-theme=dark]{--bg:#050d1e;--card:#0a1128;--bdr:#1a2357;--tx:#f0f4ff;--tx2:#8b92a3;--tx3:#4b5563}
@media(prefers-color-scheme:dark){[data-theme=auto]{--bg:#050d1e;--card:#0a1128;--bdr:#1a2357;--tx:#f0f4ff;--tx2:#8b92a3;--tx3:#4b5563}}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;font-family:Inter,-apple-system,sans-serif}

/* ‚ïê‚ïê‚ïê FIX #4 ‚Äî LAYOUT FLEXBOX: header+content separati fisicamente ‚ïê‚ïê‚ïê */
html{height:100%;overflow:hidden}
body{
  height:100dvh;overflow:hidden;
  display:flex;flex-direction:column;
  background:var(--bg);color:var(--tx);
  padding-top:env(safe-area-inset-top,0);    /* safe area TOP sul body */
  padding-bottom:env(safe-area-inset-bottom,0)
}
.hdr{flex-shrink:0;background:var(--card);border-bottom:1px solid var(--bdr);box-shadow:var(--sh)}
.main-area{
  flex:1;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;overscroll-behavior:contain
}
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

.hdr-top{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;max-width:580px;margin:0 auto}
.logo-wrap{display:flex;align-items:center;gap:10px}
.logo-img{width:34px;height:34px;object-fit:contain;border-radius:8px}
.brand{font-size:17px;font-weight:800;background:var(--grd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.1}
.brand-sub{font-size:8px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--tx2);display:block;margin-top:1px}
.hdr-r{display:flex;align-items:center;gap:8px}
.wpill{display:flex;align-items:center;gap:5px;background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.22);padding:5px 10px;border-radius:999px;cursor:pointer}
.w-ico{font-size:17px;line-height:1}
.w-tmp{font-size:14px;font-weight:800;color:var(--c)}
.w-cnd{font-size:9px;font-weight:600;color:var(--tx2);display:block;line-height:1}
.spill{background:rgba(0,212,255,.1);color:var(--c);padding:5px 10px;border-radius:999px;font-size:12px;font-weight:800;display:flex;align-items:center;gap:4px}
.nav{display:flex;border-top:1px solid var(--bdr);max-width:580px;margin:0 auto}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 4px 9px;cursor:pointer;color:var(--tx2);border:none;background:none;transition:color var(--t)}
.nb:active{opacity:.7}
.nb.on{color:var(--c)}
.nb svg{width:21px;height:21px;stroke-width:2;flex-shrink:0}
.nb span{font-size:9.5px;font-weight:700;letter-spacing:.01em}
.screen{display:none;padding:16px 18px 32px;max-width:580px;margin:0 auto;animation:up .22s}
.screen.on{display:block}
@keyframes up{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r);padding:18px;margin-bottom:14px;box-shadow:var(--sh)}
.ch{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.ct{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:700}
.ci{width:20px;height:20px;stroke:var(--c);stroke-width:2;fill:none;flex-shrink:0}
.chv{width:18px;height:18px;stroke:var(--tx2);stroke-width:2;fill:none;transition:transform var(--t)}
.chv.o{transform:rotate(180deg)}
.col{overflow:hidden;max-height:0;transition:max-height .35s cubic-bezier(.4,0,.2,1)}
.col.o{max-height:5000px}
.cg{margin-top:14px}

/* QUOTE ‚Äî rebrand copy */
.qcard{background:linear-gradient(135deg,rgba(10,17,40,.96),rgba(27,35,87,.95));
  border:1px solid rgba(0,212,255,.2);border-radius:var(--r);padding:18px 20px;margin-bottom:14px;position:relative;overflow:hidden}
.qcard::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:radial-gradient(circle,rgba(0,212,255,.12),transparent 70%)}
.qt{font-style:italic;font-size:14px;line-height:1.75;color:rgba(240,244,255,.92);margin-bottom:10px}
.qa{font-size:11px;font-weight:700;color:var(--c);text-align:right}

/* PROGRESS */
.pw{margin:12px 0 6px}
.pt{background:var(--bg);height:7px;border-radius:999px;overflow:hidden;border:1px solid var(--bdr)}
.pb{height:100%;background:var(--gr);border-radius:999px;transition:width .5s}
.pl{text-align:center;margin-top:5px;font-size:13px;font-weight:600;color:var(--tx2)}
.pp{font-size:16px;font-weight:800;color:var(--c)}
.rl{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.ri{display:flex;align-items:center;gap:10px;padding:11px 13px;background:var(--bg);border:1px solid var(--bdr);border-radius:10px;cursor:pointer;transition:var(--t)}
.ri.done{background:rgba(92,225,230,.06);border-color:var(--c3)}
.ri input[type=checkbox]{width:18px;height:18px;accent-color:var(--c);flex-shrink:0}
.ri-l{font-size:14px;font-weight:500;flex:1}
.ri.done .ri-l{text-decoration:line-through;opacity:.45}

/* ‚ïê‚ïê‚ïê FIX #8 ‚Äî 3-RING TIMER ‚ïê‚ïê‚ïê */
.tcirc-wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:14px 0}
.tcirc{position:relative;width:210px;height:210px}
.tsvg{transform:rotate(-90deg)}
.tr-track{fill:none;stroke-width:10}
.tr-track.t1{stroke:rgba(0,212,255,.12)}
.tr-track.t2{stroke:rgba(124,58,237,.12)}
.tr-track.t3{stroke:rgba(16,185,129,.12)}
.tr-prog{fill:none;stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset .5s}
.tr-prog.t1{stroke:var(--ring1)}
.tr-prog.t2{stroke:var(--ring2)}
.tr-prog.t3{stroke:var(--ring3)}
.tinner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none}
.ttime{font-family:ui-monospace,'SF Mono',monospace;font-size:28px;font-weight:800;color:var(--c);letter-spacing:-.03em;line-height:1}
.tsub{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--tx2);margin-top:3px}
.ring-legend{display:flex;gap:14px;justify-content:center;margin-top:4px}
.rl-item{display:flex;align-items:center;gap:5px;font-size:10px;font-weight:700;color:var(--tx2)}
.rl-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

.srow{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0 10px}
.st{background:var(--bg);border:1px solid var(--bdr);border-radius:10px;padding:11px;text-align:center}
.sv{font-size:20px;font-weight:800;color:var(--c)}
.sl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;color:var(--tx2);margin-top:3px}

/* Pedometer */
.pedo-row{display:flex;align-items:center;justify-content:space-between;padding:10px 13px;background:var(--bg);border:1px solid var(--bdr);border-radius:10px;margin-top:8px}
.pedo-left{display:flex;align-items:center;gap:10px}
.pedo-val{font-size:24px;font-weight:800;color:var(--ring2)}
.pedo-of{font-size:12px;color:var(--tx2);font-weight:600}
.pedo-lbl{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--tx2)}
.pedo-pbar{width:80px;height:6px;background:rgba(124,58,237,.15);border-radius:999px;overflow:hidden}
.pedo-pb{height:100%;background:var(--ring2);border-radius:999px;transition:width .4s}

/* WalkBrain end session */
.end-session{display:flex;align-items:center;gap:8px;padding:11px 14px;
  background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(16,185,129,.05));
  border:1.5px solid rgba(16,185,129,.3);border-radius:10px;margin-top:10px;cursor:pointer}
.end-session:active{transform:scale(.97)}
.es-ico{font-size:20px}
.es-txt{font-size:13px;font-weight:700;color:#10b981}
.es-sub{font-size:10px;color:var(--tx2)}

/* Wake lock banner */
.wlbanner{display:none;align-items:center;gap:10px;padding:10px 13px;background:rgba(251,191,36,.1);border:1.5px solid #f59e0b;border-radius:10px;margin-bottom:10px;font-size:12px;color:#92400e;line-height:1.5}
.wlbanner.on{display:flex}
[data-theme=dark] .wlbanner{color:#fbbf24}
.wlbanner svg{flex-shrink:0;width:18px;height:18px;stroke:#f59e0b;fill:none;stroke-width:2}

/* BUTTONS */
.btn{display:flex;align-items:center;justify-content:center;gap:7px;padding:12px 20px;
  border:none;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer;
  transition:var(--t);width:100%;margin-bottom:8px}
.btn:active{transform:scale(.97)}
.btn:last-child{margin-bottom:0}
.bp{background:var(--gr);color:#fff;box-shadow:0 2px 10px rgba(0,212,255,.28)}
.bs{background:rgba(0,212,255,.08);color:var(--c);border:1.5px solid var(--c)}
.bo{background:transparent;border:1.5px solid var(--bdr);color:var(--tx)}
.br{background:transparent;border:1.5px solid #f87171;color:#f87171}
.btn-h{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.btn-h .btn{margin-bottom:0}

/* Recording indicator */
.rind{display:none;align-items:center;gap:8px;padding:9px 12px;background:rgba(248,113,113,.1);border:1px solid #f87171;border-radius:10px;margin-bottom:10px;font-size:13px;font-weight:600;color:#f87171}
.rind.on{display:flex}
.rdot{width:8px;height:8px;border-radius:50%;background:#f87171;animation:pulse 1s infinite}

/* MUSIC */
.mlinks{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px}
.mlink{display:flex;flex-direction:column;align-items:center;gap:6px;padding:14px 8px;background:var(--bg);border:1.5px solid var(--bdr);border-radius:10px;text-decoration:none;color:var(--tx);transition:var(--t)}
.mlink:active{transform:scale(.96)}
.mlink svg{width:28px;height:28px}
.mlink span{font-size:11px;font-weight:700}
.link-warn{background:rgba(251,191,36,.08);border:1.5px solid #f59e0b;border-radius:10px;padding:12px 14px;margin-bottom:14px}
.link-warn h4{font-size:13px;font-weight:700;color:#92400e;margin-bottom:5px}
.link-warn p{font-size:12px;color:#92400e;line-height:1.6}
[data-theme=dark] .link-warn h4,[data-theme=dark] .link-warn p{color:#fbbf24}

/* ‚ïê‚ïê‚ïê FIX #3 ‚Äî INTROSPECTION POPUP: full-width card ‚ïê‚ïê‚ïê */
.ibar{
  position:fixed;left:14px;right:14px;bottom:calc(env(safe-area-inset-bottom,0px) + 74px);
  background:var(--card);border:1.5px solid var(--c);border-radius:18px;
  padding:16px 18px;z-index:9998;display:none;
  box-shadow:0 -4px 40px rgba(0,212,255,.22);animation:up .3s
}
.ibar.on{display:flex;flex-direction:column;gap:10px}
.ibar-top{display:flex;align-items:center;gap:10px}
.idot{width:10px;height:10px;border-radius:50%;background:var(--c);flex-shrink:0;animation:pulse 2s infinite}
.itime{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.05em;color:var(--c);background:rgba(0,212,255,.1);padding:3px 9px;border-radius:999px;flex-shrink:0}
.ix{width:26px;height:26px;border-radius:50%;background:rgba(0,212,255,.1);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-left:auto}
.imsg{font-size:14px;line-height:1.7;font-weight:500;color:var(--tx);padding:0 4px}
.iaction{background:var(--gr);color:#fff;border:none;border-radius:9px;padding:10px;font-weight:700;font-size:13px;cursor:pointer;width:100%}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}

/* ‚ïê‚ïê‚ïê FIX #1 ‚Äî BADGES: opacity migliorata ‚ïê‚ïê‚ïê */
.btabs{display:flex;gap:6px;margin-bottom:14px}
.btab{flex:1;padding:8px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;text-align:center;transition:var(--t);background:var(--bg);color:var(--tx2);border:none}
.btab.on{background:var(--gr);color:#fff;box-shadow:0 2px 8px rgba(0,212,255,.28)}
.bgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.badge{display:flex;flex-direction:column;align-items:center;padding:10px 6px;background:var(--bg);border:1.5px dashed var(--bdr);border-radius:10px;cursor:pointer;transition:var(--t);aspect-ratio:1}
.badge:active{transform:scale(.94)}
.badge.u{background:linear-gradient(135deg,rgba(0,212,255,.07),rgba(92,225,230,.04));border:1.5px solid var(--c3);box-shadow:0 2px 10px rgba(0,212,255,.12)}
.bi{width:32px;height:32px;opacity:.38;filter:grayscale(100%) brightness(.9);transition:opacity .3s,filter .3s;flex-shrink:0}
.badge.u .bi{opacity:1;filter:none}
.bn{font-size:8px;font-weight:700;text-align:center;margin-top:5px;line-height:1.3;color:var(--tx2)}
.badge.u .bn{color:var(--c)}

/* AI Coach ‚Äî Premium lock */
.pro-lock{display:flex;align-items:center;gap:12px;padding:14px;background:linear-gradient(135deg,rgba(124,58,237,.08),rgba(59,79,160,.06));border:1.5px solid rgba(124,58,237,.25);border-radius:12px;margin-bottom:10px}
.pro-icon{font-size:26px}
.pro-text h4{font-size:14px;font-weight:800;color:var(--n4);margin-bottom:3px}
.pro-text p{font-size:12px;color:var(--tx2);line-height:1.5}
.pro-badge{background:linear-gradient(135deg,#7c3aed,#4f46e5);color:#fff;font-size:10px;font-weight:800;padding:3px 9px;border-radius:999px;margin-left:auto;flex-shrink:0;letter-spacing:.03em}

/* WEEK GRID */
.wgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:14px}
.day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);border:1.5px solid var(--bdr);border-radius:9px;cursor:pointer;transition:var(--t);font-size:12px;font-weight:700}
.day:active{transform:scale(.94)}
.day.on{background:var(--gr);border-color:transparent;color:#fff;box-shadow:0 2px 8px rgba(0,212,255,.3)}
.dn{font-size:9px;font-weight:600;opacity:.7;margin-bottom:1px}

/* GOAL progress bars in stats */
.goal-bars{display:grid;gap:10px;margin-bottom:14px}
.gbar-row{display:flex;align-items:center;gap:10px}
.gbar-ico{width:20px;height:20px;flex-shrink:0}
.gbar-info{flex:1}
.gbar-label{font-size:11px;font-weight:700;color:var(--tx2);display:flex;justify-content:space-between;margin-bottom:4px}
.gbar-val{color:var(--tx);font-weight:800}
.gbar-track{height:8px;background:var(--bg);border:1px solid var(--bdr);border-radius:999px;overflow:hidden}
.gbar-fill{height:100%;border-radius:999px;transition:width .5s}

/* FORMS */
.fg{margin-bottom:14px}
.fl{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;color:var(--tx2);margin-bottom:6px}
input[type=text],input[type=number],input[type=url],select,textarea{
  width:100%;padding:11px 13px;border:1.5px solid var(--bdr);border-radius:10px;
  font-size:14px;background:var(--card);color:var(--tx);transition:var(--t)}
input:focus,select:focus,textarea:focus{outline:0;border-color:var(--c);box-shadow:0 0 0 3px rgba(0,212,255,.08)}
textarea{resize:vertical;min-height:88px}
.goal-inputs{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* SETTINGS */
.sitem{display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg);border:1px solid var(--bdr);border-radius:10px;cursor:pointer;transition:var(--t);margin-bottom:8px}
.sitem:active{transform:scale(.98)}
.sil{display:flex;align-items:center;gap:10px;font-size:14px;font-weight:600}
.sil svg{width:18px;height:18px;stroke:var(--c);stroke-width:2;fill:none}
.thtog{display:flex;background:var(--bg);border:1px solid var(--bdr);border-radius:999px;padding:3px;gap:2px;margin-top:6px}
.thopt{flex:1;padding:7px;border-radius:999px;text-align:center;font-size:12px;font-weight:700;cursor:pointer;transition:var(--t);color:var(--tx2);border:none;background:none}
.thopt.on{background:var(--c);color:#fff}

/* Export range */
.export-range{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.range-btn{padding:9px;border-radius:8px;border:1.5px solid var(--bdr);font-size:12px;font-weight:700;cursor:pointer;text-align:center;transition:var(--t);background:var(--bg);color:var(--tx2)}
.range-btn.on{background:var(--gr);color:#fff;border-color:transparent}
.range-btn:active{transform:scale(.96)}

/* AI GRID */
.aigrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.aib{display:flex;flex-direction:column;align-items:center;gap:8px;padding:14px;background:var(--bg);border:1.5px solid var(--bdr);border-radius:10px;cursor:pointer;text-decoration:none;color:var(--tx);transition:var(--t);position:relative}
.aib:hover{border-color:var(--c)}
.aib:active{transform:scale(.96)}
.aiico{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center}
.ain{font-size:12px;font-weight:700}
.aifree{position:absolute;top:6px;right:6px;background:rgba(16,185,129,.15);color:#10b981;font-size:9px;font-weight:800;padding:2px 6px;border-radius:999px}
.ailocked{position:absolute;top:6px;right:6px;background:rgba(124,58,237,.15);color:#7c3aed;font-size:9px;font-weight:800;padding:2px 6px;border-radius:999px}

/* MODALS */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(12px);z-index:10000;align-items:flex-end;justify-content:center}
.modal.on{display:flex;animation:up .25s}
.mbox{background:var(--card);border-radius:20px 20px 0 0;padding:24px 20px;padding-bottom:max(24px,env(safe-area-inset-bottom,24px));width:100%;max-width:580px;max-height:88dvh;overflow-y:auto}
.mhd{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.mtitle{font-size:19px;font-weight:800}
.mx{width:30px;height:30px;border-radius:50%;background:rgba(0,212,255,.1);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* Session summary card */
.summary-card{background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(0,212,255,.05));border:1.5px solid rgba(16,185,129,.3);border-radius:14px;padding:20px;text-align:center;margin-bottom:16px}
.summary-title{font-size:18px;font-weight:800;color:#10b981;margin-bottom:14px}
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.sum-item{background:var(--card);border-radius:10px;padding:12px 8px}
.sum-val{font-size:20px;font-weight:800;color:var(--c)}
.sum-lbl{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--tx2);margin-top:3px}

/* Toast */
.toast{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 80px);left:50%;transform:translateX(-50%) translateY(20px);background:var(--n);color:#fff;padding:10px 18px;border-radius:12px;font-size:13px;font-weight:700;z-index:10001;opacity:0;transition:opacity .3s,transform .3s;white-space:nowrap;pointer-events:none}
.toast.on{opacity:1;transform:translateX(-50%) translateY(0)}

/* ROUTINE EDIT */
.rsi{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.rsi input{flex:1}
.delbtn{width:36px;height:36px;border-radius:50%;background:rgba(248,113,113,.1);border:1.5px solid #f87171;color:#f87171;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}

.empty{text-align:center;padding:40px 20px;color:var(--tx2)}
.empty svg{width:50px;height:50px;margin:0 auto 14px;opacity:.18;stroke:currentColor;fill:none}
.empty h3{font-size:15px;font-weight:700;margin-bottom:6px;color:var(--tx)}
.empty p{font-size:13px;line-height:1.6}
.vbadge{position:fixed;bottom:calc(env(safe-area-inset-bottom,0px)+8px);left:12px;background:rgba(10,17,40,.85);color:#fff;padding:3px 9px;border-radius:8px;font-size:9px;font-weight:700;z-index:9997;letter-spacing:.03em}
h2.pgt{font-size:20px;font-weight:800;margin-bottom:16px}
.divider{height:1px;background:var(--bdr);margin:14px 0}
.tag{display:inline-flex;align-items:center;background:rgba(0,212,255,.08);color:var(--c);font-size:10px;font-weight:800;padding:3px 9px;border-radius:999px;letter-spacing:.04em;text-transform:uppercase}
</style>
</head>
<body>

<svg width="0" height="0" style="position:absolute;overflow:hidden">
<defs>
<linearGradient id="rg1"><stop offset="0%" stop-color="#00d4ff"/><stop offset="100%" stop-color="#5ce1e6"/></linearGradient>
<linearGradient id="rg2"><stop offset="0%" stop-color="#7c3aed"/><stop offset="100%" stop-color="#a78bfa"/></linearGradient>
<linearGradient id="rg3"><stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#34d399"/></linearGradient>
<linearGradient id="bg2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#3b4fa0"/><stop offset="50%" stop-color="#00d4ff"/><stop offset="100%" stop-color="#5ce1e6"/></linearGradient>
</defs>
</svg>

<div class="vbadge">v5.4</div>
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê INTROSPECTION (FIX #3 ‚Äî grande) ‚ïê‚ïê‚ïê -->
<div class="ibar" id="ibar">
  <div class="ibar-top">
    <div class="idot"></div>
    <span class="itime" id="iTimeLabel">5 min</span>
    <button class="ix" onclick="closeI()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
  </div>
  <div class="imsg" id="imsg"></div>
  <button class="iaction" onclick="doRec();closeI()" id="iActBtn">üéô Registra risposta</button>
</div>

<!-- ‚ïê‚ïê‚ïê HEADER (FIX #4 ‚Äî non-fixed, parte del flex layout) ‚ïê‚ïê‚ïê -->
<header class="hdr">
  <div class="hdr-top">
    <div class="logo-wrap">
      <img class="logo-img" src="./logo.png" alt="" onerror="this.style.display='none'">
      <div>
        <span class="brand" id="brandN">MindStep</span>
        <span class="brand-sub">AI Walking Intelligence</span>
      </div>
    </div>
    <div class="hdr-r">
      <div class="wpill" onclick="loadWeather(true)" title="Aggiorna meteo">
        <span class="w-ico" id="wIco">‚Äî</span>
        <div><span class="w-tmp" id="wTmp">‚Äî¬∞</span><span class="w-cnd" id="wCnd"></span></div>
      </div>
      <div class="spill">üî•<span id="strVal">0</span></div>
    </div>
  </div>
  <nav class="nav">
    <button class="nb on" onclick="goTab('home')" id="nt-home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
      <span data-k="home">Home</span>
    </button>
    <button class="nb" onclick="goTab('calendar')" id="nt-calendar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      <span data-k="history">Storico</span>
    </button>
    <button class="nb" onclick="goTab('stats')" id="nt-stats">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      <span data-k="data">Dati</span>
    </button>
    <button class="nb" onclick="goTab('music')" id="nt-music">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
      <span data-k="music">Musica</span>
    </button>
    <button class="nb" onclick="goTab('achievements')" id="nt-achievements">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="6"/><path d="M8.2 13.7L6 22l6-3 6 3-2.2-8.3"/></svg>
      <span data-k="awards">Traguardi</span>
    </button>
    <button class="nb" onclick="goTab('settings')" id="nt-settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      <span data-k="settings">Altro</span>
    </button>
  </nav>
</header>

<!-- ‚ïê‚ïê‚ïê MAIN SCROLLABLE AREA (FIX #4) ‚ïê‚ïê‚ïê -->
<div class="main-area" id="mainArea">

<!-- ONBOARDING: WELCOME -->
<div class="screen on" id="s-welcome">
  <div style="text-align:center;padding:24px 0 16px">
    <img src="./logo.png" alt="" style="width:80px;height:80px;border-radius:18px;object-fit:contain;margin-bottom:12px" onerror="this.style.display='none'">
    <!-- Rebrand -->
    <h1 style="font-size:24px;font-weight:800;background:var(--grd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px">MindStep</h1>
    <div class="tag" style="margin:0 auto 8px">AI Walking Intelligence</div>
    <p style="color:var(--tx2);font-size:13px;line-height:1.7" id="wTagline">Il tuo coach vocale mentre cammini.<br>Registra, pensa, analizza, migliora.</p>
  </div>
  <div class="card">
    <div class="fg">
      <label class="fl" data-k="language">Lingua / Language</label>
      <select id="langSel" onchange="setLang(this.value)">
        <option value="it">üáÆüáπ Italiano</option>
        <option value="en">üá¨üáß English</option>
      </select>
    </div>
    <div class="fg"><label class="fl" data-k="name">Nome</label><input type="text" id="uName" placeholder="Il tuo nome" maxlength="24"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="fg"><label class="fl" data-k="age">Et√†</label><input type="number" id="uAge" placeholder="35" min="1" max="120"></div>
      <div class="fg"><label class="fl" data-k="gender">Sesso</label>
        <select id="uGender">
          <option value="">Seleziona</option>
          <option value="M">Maschio / Male</option>
          <option value="F">Femmina / Female</option>
          <option value="A">Altro / Other</option>
        </select>
      </div>
    </div>
    <div class="fg"><label class="fl">Peso (kg)</label><input type="number" id="uWeight" placeholder="70" min="30" max="250"></div>
    <button class="btn bp" onclick="saveProfile()"><span data-k="start_btn">Continua ‚Üí</span></button>
  </div>
</div>

<!-- ONBOARDING: OBIETTIVI (FIX #7) -->
<div class="screen" id="s-goals">
  <div style="text-align:center;padding:20px 0 16px">
    <div style="font-size:36px;margin-bottom:8px">üéØ</div>
    <h1 style="font-size:22px;font-weight:800;margin-bottom:6px" data-k="set_goals">I Tuoi Obiettivi</h1>
    <p style="color:var(--tx2);font-size:13px;line-height:1.6" data-k="goals_sub">Definiamo i tuoi target giornalieri.<br>Puoi modificarli in qualsiasi momento.</p>
  </div>
  <div class="card">
    <div class="goal-inputs">
      <div class="fg">
        <label class="fl">ü¶∂ Passi / giorno</label>
        <input type="number" id="gSteps" value="8000" min="1000" max="50000" step="500">
      </div>
      <div class="fg">
        <label class="fl">‚è± Minuti cammino</label>
        <input type="number" id="gMinutes" value="30" min="5" max="180">
      </div>
      <div class="fg">
        <label class="fl">üß† Sessioni BS / giorno</label>
        <input type="number" id="gSessions" value="2" min="1" max="10">
      </div>
      <div class="fg">
        <label class="fl">üéô Min BS per sessione</label>
        <input type="number" id="gBsMins" value="30" min="5" max="60">
      </div>
    </div>
    <div style="background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.2);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:12px;color:var(--tx2);line-height:1.6">
      üí° <strong style="color:var(--tx)">I cerchi del timer</strong> si baserranno su questi obiettivi e si riempiranno al raggiungimento del 100%.
    </div>
    <button class="btn bp" onclick="saveGoals()"><span>Continua ‚Üí</span></button>
  </div>
</div>

<!-- ONBOARDING: ROUTINE SETUP -->
<div class="screen" id="s-routines">
  <div style="text-align:center;padding:20px 0 16px">
    <div style="font-size:36px;margin-bottom:8px">‚úÖ</div>
    <h1 style="font-size:22px;font-weight:800;margin-bottom:6px" data-k="your_routines">Le Tue Routine</h1>
    <p style="color:var(--tx2);font-size:13px;line-height:1.6" data-k="routines_sub">Abitudini quotidiane da tracciare durante le sessioni.</p>
  </div>
  <div class="card">
    <div id="rSetupList"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 12px">
      <span style="font-size:12px;color:var(--tx2)">Inserite:</span>
      <span style="font-size:17px;font-weight:800;color:var(--c)" id="rCount">0/10</span>
    </div>
    <button class="btn bs" onclick="addRSetup()" id="addRBtn">+ Aggiungi Routine</button>
    <button class="btn bp" onclick="saveRSetup()">üöÄ Inizia MindStep</button>
  </div>
</div>

<!-- HOME -->
<div class="screen" id="s-home">

  <!-- QUOTE ‚Äî rebrand -->
  <div class="qcard">
    <div class="qt" id="qTxt">Caricamento frase motivazionale...</div>
    <div class="qa" id="qAuth"></div>
  </div>

  <!-- ROUTINE -->
  <div class="card">
    <div class="ch" onclick="tog('rBody','rChv')">
      <div class="ct">
        <svg class="ci" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
        <span data-k="routine">Routine</span>
        <span id="rSum" style="font-size:13px;font-weight:600;color:var(--c3);margin-left:6px">0/0</span>
      </div>
      <svg class="chv o" id="rChv" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </div>
    <div class="col o cg" id="rBody">
      <div class="pw"><div class="pt"><div class="pb" id="pBar" style="width:0%"></div></div>
        <div class="pl"><span class="pp" id="pPct">0%</span> completato</div>
      </div>
      <div class="rl" id="rList"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê WALKINGBRAIN ‚Äî 3-ring timer (FIX #8) ‚ïê‚ïê‚ïê -->
  <div class="card">
    <div class="ch" onclick="tog('wBody','wChv')">
      <div class="ct">
        <svg class="ci" viewBox="0 0 24 24" fill="var(--c)" stroke="none"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>
        <span>WalkingBrain</span>
        <span id="walkStatus" style="font-size:11px;font-weight:700;color:var(--tx2);margin-left:6px"></span>
      </div>
      <svg class="chv o" id="wChv" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </div>
    <div class="col o cg" id="wBody">

      <div class="wlbanner" id="wlBanner">
        <svg viewBox="0 0 24 24"><path d="M12 9v4M12 17h.01M10.3 3.6l-8.6 15a2 2 0 001.7 3h17.2a2 2 0 001.7-3l-8.6-15a2 2 0 00-3.4 0z"/></svg>
        <span id="wlMsg">Tieni lo schermo acceso durante la registrazione.</span>
      </div>

      <!-- 3 RING TIMER -->
      <div class="tcirc-wrap">
        <div class="tcirc">
          <svg class="tsvg" width="210" height="210" viewBox="0 0 210 210">
            <!-- Ring 1: walk time (r=92, circ‚âà578) -->
            <circle class="tr-track t1" cx="105" cy="105" r="92"/>
            <circle class="tr-prog t1" id="ring1" cx="105" cy="105" r="92" stroke-dasharray="578" stroke-dashoffset="578"/>
            <!-- Ring 2: steps (r=73, circ‚âà459) -->
            <circle class="tr-track t2" cx="105" cy="105" r="73"/>
            <circle class="tr-prog t2" id="ring2" cx="105" cy="105" r="73" stroke-dasharray="459" stroke-dashoffset="459"/>
            <!-- Ring 3: brainstorm time (r=54, circ‚âà339) -->
            <circle class="tr-track t3" cx="105" cy="105" r="54"/>
            <circle class="tr-prog t3" id="ring3" cx="105" cy="105" r="54" stroke-dasharray="339" stroke-dashoffset="339"/>
          </svg>
          <div class="tinner">
            <div class="ttime" id="tDisp">00:00:00</div>
            <div class="tsub" id="tSubLbl">WALK TIME</div>
          </div>
        </div>
        <!-- Ring legend -->
        <div class="ring-legend">
          <div class="rl-item"><div class="rl-dot" style="background:var(--ring1)"></div><span id="leg1">Cammino</span></div>
          <div class="rl-item"><div class="rl-dot" style="background:var(--ring2)"></div><span id="leg2">Passi</span></div>
          <div class="rl-item"><div class="rl-dot" style="background:var(--ring3)"></div><span id="leg3">Brain</span></div>
        </div>
      </div>

      <!-- Stats row -->
      <div class="srow">
        <div class="st"><div class="sv" id="distV">0.0</div><div class="sl">km</div></div>
        <div class="st"><div class="sv" id="spdV">0.0</div><div class="sl">km/h</div></div>
        <div class="st"><div class="sv" id="kcalV">0</div><div class="sl">kcal</div></div>
      </div>

      <!-- Pedometer -->
      <div class="pedo-row">
        <div class="pedo-left">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--ring2)" stroke="none"><path d="M13.5 5.5c1 0 1.8-.8 1.8-1.8S14.5 2 13.5 2s-1.8.8-1.8 1.8.8 1.7 1.8 1.7zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1H13L6 8.3V13h2V9.6l1.8-.7"/></svg>
          <div>
            <div class="pedo-val" id="pedoVal">0</div>
            <div class="pedo-lbl" id="pedoLbl">passi (stima)</div>
          </div>
        </div>
        <div>
          <div class="pedo-of" id="pedoOf">/ <span id="goalStepsDisp">8000</span></div>
          <div class="pedo-pbar"><div class="pedo-pb" id="pedoPb" style="width:0%"></div></div>
        </div>
      </div>

      <!-- Walk buttons -->
      <div style="margin-top:12px">
        <button class="btn bp" onclick="doWalk()" id="wBtn"><span id="wBtnT" data-k="start">Inizia WalkingBrain</span></button>

        <!-- FIX #6 ‚Äî Termina sessione -->
        <div class="end-session" id="endSessionBtn" style="display:none" onclick="endSession()">
          <span class="es-ico">‚úÖ</span>
          <div>
            <div class="es-txt">Termina WalkingBrain</div>
            <div class="es-sub">Salva sessione e mostra il riepilogo</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BRAINSTORMING -->
  <div class="card">
    <div class="ch" onclick="tog('bsBody','bsChv')">
      <div class="ct">
        <svg class="ci" viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        <span data-k="brainstorm">Brainstorming</span>
        <span id="bsTimeDisp" style="font-size:11px;font-weight:700;color:var(--ring3);margin-left:6px">0:00</span>
      </div>
      <svg class="chv o" id="bsChv" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
    </div>
    <div class="col o cg" id="bsBody">
      <div class="rind" id="rInd"><div class="rdot"></div><span data-k="recording">Registrazione in corso...</span></div>
      <div class="btn-h">
        <button class="btn bs" onclick="doRec()" id="recBtn">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="6"/><path d="M19 12v1a7 7 0 01-14 0v-1M12 19v4M8 23h8"/></svg>
          <span id="recT" data-k="record">Registra</span>
        </button>
        <button class="btn bo" onclick="openX('exportM')">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
          <span data-k="export">Invia ad AI</span>
        </button>
      </div>
      <textarea id="bsTA" onchange="saveBs()" placeholder="Le tue idee durante la camminata..."></textarea>
    </div>
  </div>

  <!-- AI COACH PREVIEW (Premium) -->
  <div class="card">
    <div class="ct" style="margin-bottom:10px">
      <svg class="ci" viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/><circle cx="9" cy="10" r="1" fill="var(--c)"/><circle cx="12" cy="10" r="1" fill="var(--c)"/><circle cx="15" cy="10" r="1" fill="var(--c)"/></svg>
      <span style="font-size:14px">AI Live Coach</span>
      <span class="pro-badge">PRO</span>
    </div>
    <div class="pro-lock">
      <span class="pro-icon">ü§ñ</span>
      <div class="pro-text">
        <h4>Il tuo coach mentre cammini</h4>
        <p>Parla con l'AI in tempo reale. Adatta obiettivi, analizza pattern, suggerisce azioni.</p>
      </div>
    </div>
    <button class="btn bo" style="font-size:13px" onclick="showToast('AI Coach disponibile nella versione Pro üöÄ')">Scopri Pro</button>
  </div>

</div><!-- /s-home -->

<!-- STORICO -->
<div class="screen" id="s-calendar">
  <h2 class="pgt" data-k="history_title">Storico Attivit√†</h2>
  <div class="card" id="calCard">
    <div class="empty"><svg viewBox="0 0 24 24" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg><h3>Nessun dato</h3><p>Inizia la prima sessione WalkingBrain.</p></div>
  </div>
</div>

<!-- DATI -->
<div class="screen" id="s-stats">
  <h2 class="pgt">Performance</h2>
  <!-- Goal progress bars -->
  <div class="card">
    <p style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--tx2)">Obiettivi oggi</p>
    <div class="goal-bars" id="goalBars"></div>
  </div>
  <div class="card">
    <p style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--tx2)" data-k="weekly_data">Settimana</p>
    <div class="wgrid" id="wGrid"></div>
    <div class="srow">
      <div class="st"><div class="sv" id="wDays">0/7</div><div class="sl">Giorni</div></div>
      <div class="st"><div class="sv" id="wKm">0</div><div class="sl">KM</div></div>
      <div class="st"><div class="sv" id="wRout">0%</div><div class="sl">Routine</div></div>
    </div>
  </div>
</div>

<!-- MUSICA -->
<div class="screen" id="s-music">
  <h2 class="pgt" data-k="music_title">Musica</h2>
  <div class="card">
    <p style="font-size:12px;color:var(--tx2);margin-bottom:12px" id="musicNote">Se stai registrando, aprire un link mostrer√† un avviso.</p>
    <div class="mlinks">
      <a href="#" onclick="openMusicLink('https://open.spotify.com');return false" class="mlink">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="11" fill="#1db954"/><path d="M8 15.4c2.7-1 5.7-.9 8.2.4.3.2.7.1.9-.2.2-.3.1-.7-.2-.9-2.9-1.5-6.2-1.6-9.2-.4-.3.1-.5.5-.4.9.2.3.5.4.7.2zM7.4 13c3.2-1.2 6.8-1.1 9.8.4.4.2.8 0 1-.3.2-.4 0-.8-.3-1-3.4-1.7-7.3-1.8-10.7-.4-.4.2-.5.7-.4 1 .2.4.6.5 1 .3zM7 10.2C10.7 8.8 15 8.9 18.6 10.8c.4.2.9.1 1.1-.4.2-.4.1-.9-.4-1.1C15.4 7.4 10.5 7.3 6.4 8.9c-.5.2-.7.7-.5 1.1.2.4.7.6 1.1.2z" fill="white"/></svg>
        <span>Spotify</span>
      </a>
      <a href="#" onclick="openMusicLink('https://music.youtube.com');return false" class="mlink">
        <svg viewBox="0 0 24 24"><rect width="24" height="24" rx="5" fill="#ff0000"/><polygon points="10,8 17,12 10,16" fill="white"/></svg>
        <span>YouTube</span>
      </a>
      <a href="#" onclick="openMusicLink('https://music.apple.com');return false" class="mlink">
        <svg viewBox="0 0 24 24"><rect width="24" height="24" rx="5" fill="#fc3c44"/><path d="M17 6l-6 1.2v7.2a2.5 2.5 0 10.8 1.8V10.5l4.4-.9V13a2.5 2.5 0 10.8 1.8z" fill="white"/></svg>
        <span>Apple</span>
      </a>
    </div>
    <div class="fg">
      <label class="fl">Link Personalizzato</label>
      <input type="url" id="cusUrl" placeholder="https://...">
      <button class="btn bs" onclick="opCus()" style="margin-top:8px">Apri</button>
    </div>
    <div class="fg" style="margin-top:2px">
      <label class="fl">Podcast</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <a href="#" onclick="openMusicLink('https://open.spotify.com/genre/podcasts-page');return false" class="btn bo" style="text-decoration:none;margin-bottom:0;font-size:13px">Spotify</a>
        <a href="#" onclick="openMusicLink('https://podcasts.apple.com');return false" class="btn bo" style="text-decoration:none;margin-bottom:0;font-size:13px">Apple</a>
      </div>
    </div>
  </div>
</div>

<!-- TRAGUARDI -->
<div class="screen" id="s-achievements">
  <h2 class="pgt">Traguardi</h2>
  <div class="btabs">
    <button class="btab on" onclick="fBadge('all')" id="bt-all">Tutti</button>
    <button class="btab" onclick="fBadge('daily')" id="bt-daily">Daily</button>
    <button class="btab" onclick="fBadge('weekly')" id="bt-weekly">Weekly</button>
    <button class="btab" onclick="fBadge('monthly')" id="bt-monthly">Monthly</button>
  </div>
  <div class="card" style="padding:14px"><div class="bgrid" id="bGrid"></div></div>
</div>

<!-- IMPOSTAZIONI -->
<div class="screen" id="s-settings">
  <h2 class="pgt">Impostazioni</h2>
  <div class="card">
    <div class="fg">
      <label class="fl">Tema</label>
      <div class="thtog">
        <button class="thopt" onclick="setTh('light')" id="th-light">Chiaro</button>
        <button class="thopt on" onclick="setTh('auto')" id="th-auto">Auto</button>
        <button class="thopt" onclick="setTh('dark')" id="th-dark">Scuro</button>
      </div>
    </div>
    <div class="fg">
      <label class="fl">Lingua</label>
      <select id="langSet" onchange="setLang(this.value)">
        <option value="it">üáÆüáπ Italiano</option>
        <option value="en">üá¨üáß English</option>
      </select>
    </div>
  </div>
  <div class="sitem" onclick="doEditPro()"><div class="sil"><svg viewBox="0 0 24 24"><circle cx="12" cy="7" r="4"/><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/></svg>Modifica Profilo</div><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--tx2)" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></div>
  <!-- FIX #7: obiettivi modificabili anche da settings -->
  <div class="sitem" onclick="openX('goalsM')"><div class="sil"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 8v4l3 3"/></svg>Obiettivi Personali</div><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--tx2)" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></div>
  <div class="sitem" onclick="openX('editRM')"><div class="sil"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Modifica Routine</div><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--tx2)" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></div>
  <!-- FIX #9: solo CSV, rimosso JSON -->
  <div class="sitem" onclick="openX('exportAllM')"><div class="sil"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>Esporta Dati CSV</div><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--tx2)" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></div>
  <div class="sitem" onclick="resetAll()" style="color:#f87171"><div class="sil" style="color:#f87171"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>Reset App</div><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

</div><!-- /main-area -->

<!-- MODALS -->

<!-- SESSION SUMMARY (FIX #6) -->
<div class="modal" id="summaryM">
  <div class="mbox">
    <div class="mhd"><h3 class="mtitle">üèÅ Sessione Completata</h3><button class="mx" onclick="closeX('summaryM')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>
    <div class="summary-card">
      <div class="summary-title" id="sumTitle">WalkingBrain completata!</div>
      <div class="summary-grid">
        <div class="sum-item"><div class="sum-val" id="sumKm">0.0</div><div class="sum-lbl">km</div></div>
        <div class="sum-item"><div class="sum-val" id="sumSteps">0</div><div class="sum-lbl">passi</div></div>
        <div class="sum-item"><div class="sum-val" id="sumTime">0:00</div><div class="sum-lbl">durata</div></div>
      </div>
    </div>
    <button class="btn bp" onclick="closeX('summaryM')">Perfetto üöÄ</button>
    <button class="btn bo" onclick="openX('exportM');closeX('summaryM')">Invia transcript ad AI ‚Üí</button>
  </div>
</div>

<!-- EXPORT BRAINSTORM -->
<div class="modal" id="exportM">
  <div class="mbox">
    <div class="mhd"><h3 class="mtitle">Invia a AI</h3><button class="mx" onclick="closeX('exportM')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>
    <button class="btn bp" onclick="expTxt()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/></svg>
      Scarica trascrizione (.txt)
    </button>
    <p style="font-size:11px;font-weight:700;color:var(--tx2);text-transform:uppercase;letter-spacing:.05em;margin:10px 0 8px">Copia e invia ad AI:</p>
    <!-- FIX #5: clipboard + apertura URL -->
    <div class="aigrid">
      <a href="#" onclick="sendAI('claude');return false" class="aib">
        <div class="aiico" style="background:linear-gradient(135deg,#D97757,#c56647)"><svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 2L2 7l10 5 10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg></div>
        <span class="ain">Claude</span><span class="aifree">FREE</span>
      </a>
      <a href="#" onclick="sendAI('chatgpt');return false" class="aib">
        <div class="aiico" style="background:linear-gradient(135deg,#10a37f,#0d8b6a)"><svg width="18" height="18" viewBox="0 0 24 24" fill="white"><circle cx="12" cy="12" r="9"/></svg></div>
        <span class="ain">ChatGPT</span><span class="aifree">FREE</span>
      </a>
      <a href="#" onclick="sendAI('gemini');return false" class="aib">
        <div class="aiico" style="background:linear-gradient(135deg,#4285f4,#3367d6)"><svg width="18" height="18" viewBox="0 0 24 24" fill="white"><polygon points="12 2 15 9 22 9.5 17 14 18.5 21 12 17.5 5.5 21 7 14 2 9.5 9 9"/></svg></div>
        <span class="ain">Gemini</span><span class="aifree">FREE</span>
      </a>
      <a href="#" onclick="sendAI('copilot');return false" class="aib">
        <div class="aiico" style="background:linear-gradient(135deg,#0078d4,#005a9e)"><svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 2l9 4.5v9L12 22l-9-6.5v-9z"/></svg></div>
        <span class="ain">Copilot</span><span class="aifree">FREE</span>
      </a>
    </div>
    <p style="font-size:11px;color:var(--tx2);text-align:center;margin-top:10px;line-height:1.5">Il testo viene copiato negli appunti automaticamente.<br>Incollalo nella chat con <strong>Cmd/Ctrl+V</strong>.</p>
  </div>
</div>

<!-- FIX #3 ‚Äî EXPORT CSV (senza JSON) -->
<div class="modal" id="exportAllM">
  <div class="mbox">
    <div class="mhd"><h3 class="mtitle">Esporta Dati CSV</h3><button class="mx" onclick="closeX('exportAllM')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>
    <p style="font-size:13px;color:var(--tx2);margin-bottom:14px">Seleziona il periodo:</p>
    <div class="export-range">
      <button class="range-btn on" onclick="selRange(this,1)">Oggi</button>
      <button class="range-btn" onclick="selRange(this,7)">Settimana</button>
      <button class="range-btn" onclick="selRange(this,15)">15 giorni</button>
      <button class="range-btn" onclick="selRange(this,30)">Mese</button>
      <button class="range-btn" onclick="selRange(this,60)">60 giorni</button>
      <button class="range-btn" onclick="selRange(this,90)">90 giorni</button>
    </div>
    <button class="btn bp" onclick="expCSV()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/></svg>
      Scarica CSV
    </button>
  </div>
</div>

<!-- MUSIC WARNING (FIX #7) -->
<div class="modal" id="musicWarnM">
  <div class="mbox">
    <div class="mhd"><h3 class="mtitle">‚ö†Ô∏è Link Esterno</h3><button class="mx" onclick="closeX('musicWarnM')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>
    <div class="link-warn"><h4>Registrazione attiva</h4><p id="musicWarnTxt">Aprire questo link potrebbe interrompere la registrazione vocale. Continuare?</p></div>
    <button class="btn bp" onclick="confirmMusicLink()">Apri comunque</button>
    <button class="btn bo" onclick="closeX('musicWarnM')">Annulla</button>
  </div>
</div>

<!-- BADGE DETAIL -->
<div class="modal" id="bdgM">
  <div class="mbox">
    <div class="mhd"><h3 class="mtitle" id="bdgMT">Traguardo</h3><button class="mx" onclick="closeX('bdgM')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>
    <div style="text-align:center;padding:8px 0 16px"><div id="bdgMI" style="margin:0 auto 14px"></div><p id="bdgMD" style="color:var(--tx2);font-size:14px;line-height:1.7"></p><div id="bdgMS" style="margin-top:12px;font-size:13px;font-weight:700"></div></div>
  </div>
</div>

<!-- EDIT ROUTINES (FIX #2) -->
<div class="modal" id="editRM">
  <div class="mbox">
    <div class="mhd"><h3 class="mtitle">Modifica Routine</h3><button class="mx" onclick="closeX('editRM')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>
    <div id="eRList"></div>
    <button class="btn bs" onclick="addER()">+ Aggiungi</button>
    <button class="btn bp" onclick="saveER()">Salva Modifiche</button>
  </div>
</div>

<!-- GOALS MODAL (FIX #7: anche da settings) -->
<div class="modal" id="goalsM">
  <div class="mbox">
    <div class="mhd"><h3 class="mtitle">üéØ Obiettivi</h3><button class="mx" onclick="closeX('goalsM')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>
    <div class="goal-inputs">
      <div class="fg"><label class="fl">ü¶∂ Passi / giorno</label><input type="number" id="gStepsM" min="1000" max="50000" step="500"></div>
      <div class="fg"><label class="fl">‚è± Minuti cammino</label><input type="number" id="gMinutesM" min="5" max="180"></div>
      <div class="fg"><label class="fl">üß† Sessioni BS</label><input type="number" id="gSessionsM" min="1" max="10"></div>
      <div class="fg"><label class="fl">üéô Min BS/sessione</label><input type="number" id="gBsMinsM" min="5" max="60"></div>
    </div>
    <button class="btn bp" onclick="saveGoalsModal()">Salva Obiettivi</button>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MINDSTEP v5.4 ‚Äî AI Walking Intelligence
   FIX #1  Badge opacity + redistribuzione
   FIX #2  Routine edit durante sessione
   FIX #3  Popup introspection grande
   FIX #4  Layout flexbox (no scroll-through)
   FIX #5  ChatGPT: clipboard + open URL
   FIX #6  Persistenza walk + Termina Sessione
   FIX #7  Obiettivi onboarding + settings
   FIX #8  3-ring timer basato su obiettivi
   FIX #9  Rimosso export JSON
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const VER='5.4';
let routines=[], goals={steps:8000,minutes:30,sessions:2,bsMins:30};
let W={on:false,paused:false,t0:0,el:0,pt:0,dist:0,lp:null,wid:null};
let tInt=null, saveInt=null;
let recO=null, recOn=false;
let transcript='', interimT='';
let lang='it', badgeFilt='all', iShown={};
let wakeLock=null, selectedRange=1, pendingMusicUrl='';
let stepCount=0, lastAccMag=0, lastStepTime=0, pedoActive=false;
let bsElapsed=0, bsStart=null; // brainstorm timer

/* ‚îÄ‚îÄ I18N ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const TR={
  it:{home:'Home',history:'Storico',data:'Dati',music:'Musica',awards:'Traguardi',settings:'Altro',
    name:'Nome',age:'Et√†',gender:'Sesso',language:'Lingua',start_btn:'Continua ‚Üí',
    set_goals:'I Tuoi Obiettivi',goals_sub:'Target giornalieri ‚Äî modificabili in Settings.',
    your_routines:'Le Tue Routine',routines_sub:'Abitudini quotidiane da tracciare.',
    routine:'Routine',completed:'Completato',brainstorm:'Brainstorming',
    recording:'Registrazione in corso...',record:'Registra',stop:'Stop',export:'Invia ad AI',
    history_title:'Storico Attivit√†',weekly_data:'Settimana',
    music_title:'Musica',settings_title:'Impostazioni',
    all:'Tutti',daily:'Daily',weekly:'Weekly',monthly:'Monthly',
    unlocked:'Sbloccato',locked:'Da sbloccare',steps:'passi',
    start:'Inizia WalkingBrain'},
  en:{home:'Home',history:'History',data:'Data',music:'Music',awards:'Awards',settings:'More',
    name:'Name',age:'Age',gender:'Gender',language:'Language',start_btn:'Continue ‚Üí',
    set_goals:'Your Goals',goals_sub:'Daily targets ‚Äî editable in Settings.',
    your_routines:'Your Routines',routines_sub:'Daily habits to track.',
    routine:'Routine',completed:'Completed',brainstorm:'Brainstorming',
    recording:'Recording...',record:'Record',stop:'Stop',export:'Send to AI',
    history_title:'Activity History',weekly_data:'Weekly',
    music_title:'Music',settings_title:'Settings',
    all:'All',daily:'Daily',weekly:'Weekly',monthly:'Monthly',
    unlocked:'Unlocked',locked:'Locked',steps:'steps',
    start:'Start WalkingBrain'}
};

function setLang(l){
  lang=l;localStorage.setItem('ms_lang',l);
  document.getElementById('htmlRoot').lang=l;
  ['langSel','langSet'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=l});
  document.querySelectorAll('[data-k]').forEach(el=>{
    const k=el.getAttribute('data-k');if(TR[l]&&TR[l][k])el.textContent=TR[l][k];
  });
  const tl=document.getElementById('wTagline');
  if(tl)tl.innerHTML=l==='en'
    ?'Your AI voice coach while walking.<br>Record, think, analyze, improve.'
    :'Il tuo coach vocale mentre cammini.<br>Registra, pensa, analizza, migliora.';
  const mn=document.getElementById('musicNote');
  if(mn)mn.textContent=l==='en'
    ?'If recording, opening a link will show a warning.'
    :'Se stai registrando, aprire un link mostrer√† un avviso.';
  renderBadges(badgeFilt);
}

/* ‚îÄ‚îÄ QUOTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const QI={
  it:[
    {t:"Le migliori idee arrivano camminando.",a:"Friedrich Nietzsche"},
    {t:"Il corpo in movimento libera la mente dalla staticit√†.",a:"MindStep"},
    {t:"Cammina come se potessi toccare il suolo con i tuoi piedi.",a:"Thich Nhat Hanh"},
    {t:"Ogni passo all'esterno √® un passo pi√π vicino a te stesso.",a:"Friedrich Nietzsche"},
    {t:"La chiarezza non si trova seduti. Si cammina verso di essa.",a:"MindStep"},
    {t:"I grandi pensatori erano grandi camminatori.",a:"Charles Darwin"},
    {t:"Non cercare l'idea perfetta. Cammina verso quella abbastanza buona.",a:"MindStep"}
  ],
  en:[
    {t:"All truly great thoughts are conceived while walking.",a:"Friedrich Nietzsche"},
    {t:"A body in motion unlocks a mind in stasis.",a:"MindStep"},
    {t:"Walk as if you are kissing the Earth with your feet.",a:"Thich Nhat Hanh"},
    {t:"Clarity is not found sitting. You walk towards it.",a:"MindStep"},
    {t:"Great thinkers were great walkers.",a:"Charles Darwin"},
    {t:"The best time to have an idea is while your feet are moving.",a:"MindStep"}
  ]
};
function loadQuote(){
  const pool=QI[lang]||QI.it;
  const q=pool[Math.floor(Math.random()*pool.length)];
  document.getElementById('qTxt').textContent='"'+q.t+'"';
  document.getElementById('qAuth').textContent='‚Äî '+q.a;
  fetch('https://api.quotable.io/random?tags=inspirational&maxLength=120')
    .then(r=>r.json())
    .then(d=>{document.getElementById('qTxt').textContent='"'+d.content+'"';document.getElementById('qAuth').textContent='‚Äî '+d.author})
    .catch(()=>{});
}

/* ‚îÄ‚îÄ FIX #1 ‚Äî BADGES (redistribuiti: 8 daily, 14 weekly, 21 monthly) */
const BADGES=[
  /* DAILY: 8 */
  {id:'dawn',n:'Alba Produttiva',ne:'Productive Dawn',cat:'daily',ic:'sun',d:'Sessione prima delle 08:00'},
  {id:'zen',n:'Camminatore Zen',ne:'Zen Walker',cat:'daily',ic:'circ',d:'30 minuti continui'},
  {id:'p10k',n:'10.000 Passi',ne:'10K Steps',cat:'daily',ic:'crown',d:'10.000 passi in un giorno'},
  {id:'flow5',n:'Flusso',ne:'Flow State',cat:'daily',ic:'strm',d:'5+ minuti di registrazione'},
  {id:'double',n:'Doppia Sessione',ne:'Double Session',cat:'daily',ic:'inf',d:'2 sessioni in un giorno'},
  {id:'evening',n:'Mente Serale',ne:'Evening Mind',cat:'daily',ic:'moon',d:'Sessione dopo le 18:00'},
  {id:'seed',n:'Primo Pensiero',ne:'First Thought',cat:'daily',ic:'seed',d:'Prima nota del giorno'},
  {id:'synth',n:'Sintesi AI',ne:'AI Synthesis',cat:'daily',ic:'nod',d:'Transcript inviato ad AI'},
  /* WEEKLY: 14 */
  {id:'steady',n:'Ritmo Costante',ne:'Steady Rhythm',cat:'weekly',ic:'wave',d:'5 giorni su 7 attivi'},
  {id:'iwk',n:'Settimana di Ferro',ne:'Iron Week',cat:'weekly',ic:'hex',d:'7/7 giorni consecutivi'},
  {id:'enc',n:'60 Min Brain',ne:'60 Min Brain',cat:'weekly',ic:'book',d:'60 min brainstorming totali'},
  {id:'vol',n:'70K Passi',ne:'70K Steps',cat:'weekly',ic:'mtn',d:'70.000 passi settimanali'},
  {id:'pm',n:'Pace Maker',ne:'Pace Maker',cat:'weekly',ic:'aup',d:'+5% ritmo rispetto settimana prec.'},
  {id:'expl',n:'Esploratore',ne:'Explorer',cat:'weekly',ic:'comp',d:'5+ percorsi diversi'},
  {id:'wend',n:'Guerriero Weekend',ne:'Weekend Warrior',cat:'weekly',ic:'shld',d:'90+ min nel weekend'},
  {id:'aic',n:'AI Collaborator',ne:'AI Collaborator',cat:'weekly',ic:'net',d:'5+ export ad AI'},
  {id:'cons',n:'King Costanza',ne:'Consistency King',cat:'weekly',ic:'clock',d:'Stesso orario ¬±1h √ó 5 giorni'},
  {id:'asc',n:'Ascensione',ne:'Ascension',cat:'weekly',ic:'stairs',d:'Durata crescente ogni sessione'},
  {id:'vis',n:'Visionario',ne:'Visionary',cat:'weekly',ic:'tele',d:'7 note/7 giorni'},
  {id:'ps',n:'Problem Solver',ne:'Problem Solver',cat:'weekly',ic:'puzz',d:'5 sessioni con task definiti'},
  {id:'dtk',n:'Deep Thinker',ne:'Deep Thinker',cat:'weekly',ic:'depth',d:'3 sessioni > 30 minuti'},
  {id:'org',n:'Mente Organizzata',ne:'Organized Mind',cat:'weekly',ic:'grid',d:'Note categorizzate 100%'},
  /* MONTHLY: 21 */
  {id:'meta',n:'Metamorfosi',ne:'Metamorphosis',cat:'monthly',ic:'butt',d:'200.000 passi mensili'},
  {id:'cent',n:'Centurione',ne:'Centurion',cat:'monthly',ic:'road',d:'100 km percorsi nel mese'},
  {id:'im',n:'Mese di Ferro',ne:'Iron Month',cat:'monthly',ic:'fort',d:'30/30 giorni attivi'},
  {id:'peak',n:'Peak Performer',ne:'Peak Performer',cat:'monthly',ic:'pk',d:'10 giorni > 10.000 passi'},
  {id:'mm',n:'Master Mind',ne:'Master Mind',cat:'monthly',ic:'brain',d:'500+ minuti brainstorming'},
  {id:'ka',n:'Knowledge Architect',ne:'Knowledge Architect',cat:'monthly',ic:'bp',d:'100+ note archiviate'},
  {id:'sync',n:'Sincronia Totale',ne:'Total Sync',cat:'monthly',ic:'wsync',d:'20+ ore di movimento'},
  {id:'ais',n:'AI Synergy',ne:'AI Synergy',cat:'monthly',ic:'hai',d:'20+ collaborazioni AI'},
  {id:'str',n:'Strategist',ne:'Strategist',cat:'monthly',ic:'chess',d:'Top 10 idee revisionate'},
  {id:'vol2',n:'Volume Maestro',ne:'Volume Master',cat:'monthly',ic:'mtn',d:'300.000 passi totali'},
  {id:'phd',n:'Mente in Espansione',ne:'Expanding Mind',cat:'monthly',ic:'brain',d:'10 temi diversi esplorati'},
  {id:'dawn2',n:'30 Albe',ne:'30 Dawns',cat:'monthly',ic:'sun2',d:'30 sessioni mattutine'},
  {id:'night',n:'30 Sere',ne:'30 Evenings',cat:'monthly',ic:'moon2',d:'30 sessioni serali'},
  {id:'spd',n:'Speed Thinker',ne:'Speed Thinker',cat:'monthly',ic:'bolt',d:'Sessioni > 6 km/h'},
  {id:'ultra',n:'Ultra Endurance',ne:'Ultra Endurance',cat:'monthly',ic:'inf',d:'Sessione > 2 ore'},
  {id:'coach',n:'Self Coach',ne:'Self Coach',cat:'monthly',ic:'tgt',d:'Tutti gli obiettivi raggiunti'},
  {id:'habit',n:'Abitudini Solide',ne:'Solid Habits',cat:'monthly',ic:'circ',d:'Routine 100% √ó 20 giorni'},
  {id:'comm',n:'Impegno Totale',ne:'Total Commitment',cat:'monthly',ic:'shld',d:'90 giorni senza interruzioni'},
  {id:'spark',n:'Idea Spark',ne:'Idea Spark',cat:'monthly',ic:'flash',d:'50 sessioni brainstorming'},
  {id:'elite',n:'MindStep Elite',ne:'MindStep Elite',cat:'monthly',ic:'hex',d:'Tutti i badge sbloccati'},
  {id:'legend',n:'Walking Legend',ne:'Walking Legend',cat:'monthly',ic:'crown',d:'365 sessioni totali'}
];

function getBadgeIcon(ic,u){
  const s=u?'url(#bg2)':'#9CA3AF';
  const M={
    pent:`<svg class="bi" viewBox="0 0 32 32" fill="none"><polygon points="16,4 28,12 24,26 8,26 4,12" stroke="${s}" stroke-width="2"/></svg>`,
    wave:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M2 16L8 16 10 10 12 22 14 16 16 16 18 10 20 22 22 16 30 16" stroke="${s}" stroke-width="2" stroke-linecap="round"/></svg>`,
    sun:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="18" r="6" stroke="${s}" stroke-width="2"/><line x1="16" y1="4" x2="16" y2="8" stroke="${s}" stroke-width="2" stroke-linecap="round"/><line x1="4" y1="18" x2="28" y2="18" stroke="${s}" stroke-width="1.5" stroke-dasharray="2,2"/></svg>`,
    bolt:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M18 4L10 18h7L12 28l10-14h-6z" stroke="${s}" stroke-width="2" stroke-linejoin="round"/></svg>`,
    inf:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M6 16c0-3.3 2.7-6 6-6 3.3 0 5 3 8 3s6-2.7 6-6-2.7-6-6-6c-3.3 0-5 3-8 3S6 16 6 16z" stroke="${s}" stroke-width="2"/></svg>`,
    moon:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M20 6a10 10 0 000 20 8 8 0 110-20" stroke="${s}" stroke-width="2"/></svg>`,
    tgt:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="${s}" stroke-width="2"/><circle cx="16" cy="16" r="7" stroke="${s}" stroke-width="2"/><circle cx="16" cy="16" r="2" fill="${s}"/></svg>`,
    crown:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M6 10l4 8h12l4-8-5 3-5-7-5 7z" stroke="${s}" stroke-width="2" stroke-linejoin="round"/><line x1="6" y1="22" x2="26" y2="22" stroke="${s}" stroke-width="2"/></svg>`,
    circ:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="10" stroke="${s}" stroke-width="2"/><path d="M11 16l4 4 6-6" stroke="${s}" stroke-width="2" stroke-linecap="round"/></svg>`,
    strm:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M4 10Q10 6 16 10T28 10" stroke="${s}" stroke-width="2"/><path d="M4 16Q10 12 16 16T28 16" stroke="${s}" stroke-width="2"/><path d="M4 22Q10 18 16 22T28 22" stroke="${s}" stroke-width="2"/></svg>`,
    nod:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="8" cy="8" r="3" stroke="${s}" stroke-width="2"/><circle cx="24" cy="8" r="3" stroke="${s}" stroke-width="2"/><circle cx="16" cy="24" r="3" stroke="${s}" stroke-width="2"/><line x1="8" y1="8" x2="16" y2="24" stroke="${s}" stroke-width="1.5"/><line x1="24" y1="8" x2="16" y2="24" stroke="${s}" stroke-width="1.5"/><line x1="8" y1="8" x2="24" y2="8" stroke="${s}" stroke-width="1.5"/></svg>`,
    seed:`<svg class="bi" viewBox="0 0 32 32" fill="none"><ellipse cx="16" cy="16" rx="6" ry="9" stroke="${s}" stroke-width="2"/><line x1="16" y1="7" x2="16" y2="25" stroke="${s}" stroke-width="1.5"/></svg>`,
    flash:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M16 4L8 18h8l-2 10 10-14h-8z" stroke="${s}" stroke-width="2" stroke-linejoin="round"/></svg>`,
    sun2:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="6" stroke="${s}" stroke-width="2"/><line x1="16" y1="4" x2="16" y2="8" stroke="${s}" stroke-width="2" stroke-linecap="round"/><line x1="24" y1="8" x2="22" y2="10" stroke="${s}" stroke-width="2" stroke-linecap="round"/></svg>`,
    moon2:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M22 8A10 10 0 1012 22a7 7 0 0010-14z" stroke="${s}" stroke-width="2"/></svg>`,
    hex:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M16 4L26 10V22L16 28L6 22V10z" stroke="${s}" stroke-width="2" stroke-linejoin="round"/><circle cx="16" cy="16" r="4" fill="${s}" opacity=".5"/></svg>`,
    path:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M4 16Q8 8 12 16T20 16T28 16" stroke="${s}" stroke-width="2"/></svg>`,
    aup:`<svg class="bi" viewBox="0 0 32 32" fill="none"><line x1="16" y1="26" x2="16" y2="6" stroke="${s}" stroke-width="2" stroke-linecap="round"/><path d="M10 12l6-6 6 6" stroke="${s}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
    stairs:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M6 26H10V22H14V18H18V14H22V10H26" stroke="${s}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
    clock:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="10" stroke="${s}" stroke-width="2"/><path d="M16 10v6l4 2" stroke="${s}" stroke-width="2" stroke-linecap="round"/></svg>`,
    mtn:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M4 26L16 8l12 18H4z" stroke="${s}" stroke-width="2" stroke-linejoin="round"/></svg>`,
    shld:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M16 4L6 8v8c0 6 4.5 11 10 12 5.5-1 10-6 10-12V8z" stroke="${s}" stroke-width="2" stroke-linejoin="round"/></svg>`,
    comp:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="10" stroke="${s}" stroke-width="2"/><polygon points="16,10 18,15 16,20 14,15" fill="${s}"/></svg>`,
    book:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M6 4h14a2 2 0 012 2v20H8a2 2 0 01-2-2V4z" stroke="${s}" stroke-width="2"/><line x1="10" y1="10" x2="18" y2="10" stroke="${s}" stroke-width="1.5"/></svg>`,
    grid:`<svg class="bi" viewBox="0 0 32 32" fill="none"><rect x="5" y="5" width="8" height="8" rx="1" stroke="${s}" stroke-width="2"/><rect x="19" y="5" width="8" height="8" rx="1" stroke="${s}" stroke-width="2"/><rect x="5" y="19" width="8" height="8" rx="1" stroke="${s}" stroke-width="2"/><rect x="19" y="19" width="8" height="8" rx="1" stroke="${s}" stroke-width="2"/></svg>`,
    tele:`<svg class="bi" viewBox="0 0 32 32" fill="none"><line x1="8" y1="24" x2="24" y2="8" stroke="${s}" stroke-width="2" stroke-linecap="round"/><ellipse cx="24" cy="8" rx="4" ry="2" transform="rotate(-45 24 8)" stroke="${s}" stroke-width="2" fill="none"/></svg>`,
    puzz:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M12 6h8v4a2 2 0 002 2h4v8h-4a2 2 0 00-2 2v4h-8v-4a2 2 0 00-2-2H6v-8h4a2 2 0 002-2V6z" stroke="${s}" stroke-width="2"/></svg>`,
    net:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="3" fill="${s}"/><circle cx="6" cy="8" r="2" stroke="${s}" stroke-width="2"/><circle cx="26" cy="8" r="2" stroke="${s}" stroke-width="2"/><circle cx="6" cy="24" r="2" stroke="${s}" stroke-width="2"/><circle cx="26" cy="24" r="2" stroke="${s}" stroke-width="2"/><line x1="8" y1="9" x2="14" y2="15" stroke="${s}" stroke-width="1.5"/><line x1="24" y1="9" x2="18" y2="15" stroke="${s}" stroke-width="1.5"/><line x1="8" y1="23" x2="14" y2="17" stroke="${s}" stroke-width="1.5"/><line x1="24" y1="23" x2="18" y2="17" stroke="${s}" stroke-width="1.5"/></svg>`,
    depth:`<svg class="bi" viewBox="0 0 32 32" fill="none"><ellipse cx="16" cy="8" rx="10" ry="4" stroke="${s}" stroke-width="2"/><path d="M6 8v8c0 2.2 4.5 4 10 4s10-1.8 10-4V8" stroke="${s}" stroke-width="2"/></svg>`,
    butt:`<svg class="bi" viewBox="0 0 32 32" fill="none"><ellipse cx="10" cy="12" rx="6" ry="8" stroke="${s}" stroke-width="2"/><ellipse cx="22" cy="12" rx="6" ry="8" stroke="${s}" stroke-width="2"/><line x1="16" y1="5" x2="16" y2="27" stroke="${s}" stroke-width="2"/></svg>`,
    road:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M8 28L14 4h4l6 24" stroke="${s}" stroke-width="2" stroke-linecap="round"/><line x1="14" y1="14" x2="18" y2="14" stroke="${s}" stroke-width="1.5" stroke-dasharray="2,2"/></svg>`,
    wsync:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M2 16Q6 10 10 16T18 16T26 16" stroke="${s}" stroke-width="2"/></svg>`,
    fort:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M6 28V16l10-8 10 8v12H6z" stroke="${s}" stroke-width="2" stroke-linejoin="round"/><rect x="12" y="20" width="8" height="8" stroke="${s}" stroke-width="1.5"/></svg>`,
    pk:`<svg class="bi" viewBox="0 0 32 32" fill="none"><path d="M4 28L16 8l12 20H4z" stroke="${s}" stroke-width="2" stroke-linejoin="round"/></svg>`,
    brain:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="10" stroke="${s}" stroke-width="2"/><circle cx="12" cy="14" r="2" fill="${s}"/><circle cx="20" cy="14" r="2" fill="${s}"/><circle cx="16" cy="20" r="2" fill="${s}"/><line x1="12" y1="14" x2="16" y2="20" stroke="${s}" stroke-width="1.5"/><line x1="20" y1="14" x2="16" y2="20" stroke="${s}" stroke-width="1.5"/><line x1="12" y1="14" x2="20" y2="14" stroke="${s}" stroke-width="1.5"/></svg>`,
    chess:`<svg class="bi" viewBox="0 0 32 32" fill="none"><rect x="6" y="20" width="20" height="8" rx="1" stroke="${s}" stroke-width="2"/><path d="M16 20c0-4 4-6 4-10a4 4 0 00-8 0c0 4 4 6 4 10z" stroke="${s}" stroke-width="2"/></svg>`,
    bp:`<svg class="bi" viewBox="0 0 32 32" fill="none"><rect x="4" y="4" width="24" height="24" rx="2" stroke="${s}" stroke-width="2"/><line x1="4" y1="12" x2="28" y2="12" stroke="${s}" stroke-width="1"/><line x1="4" y1="20" x2="28" y2="20" stroke="${s}" stroke-width="1"/><line x1="12" y1="4" x2="12" y2="28" stroke="${s}" stroke-width="1"/><line x1="20" y1="4" x2="20" y2="28" stroke="${s}" stroke-width="1"/></svg>`,
    hai:`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="10" cy="10" r="4" stroke="${s}" stroke-width="2"/><path d="M4 24c0-3.3 2.7-6 6-6" stroke="${s}" stroke-width="2" stroke-linecap="round"/><rect x="18" y="6" width="10" height="10" rx="2" stroke="${s}" stroke-width="2"/><line x1="14" y1="24" x2="28" y2="24" stroke="${s}" stroke-width="1.5" stroke-linecap="round"/></svg>`
  };
  return M[ic]||`<svg class="bi" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="10" stroke="${s}" stroke-width="2"/></svg>`;
}

function renderBadges(f){
  badgeFilt=f;
  document.querySelectorAll('.btab').forEach(t=>t.classList.remove('on'));
  const bt=document.getElementById('bt-'+f);if(bt)bt.classList.add('on');
  const grid=document.getElementById('bGrid');
  const ul=JSON.parse(localStorage.getItem('ms_badges')||'[]');
  const list=f==='all'?BADGES:BADGES.filter(b=>b.cat===f);
  grid.innerHTML='';
  list.forEach(b=>{
    const u=ul.includes(b.id);
    const d=document.createElement('div');
    d.className='badge'+(u?' u':'');
    const nm=lang==='en'?(b.ne||b.n):b.n;
    d.innerHTML=getBadgeIcon(b.ic,u)+`<div class="bn">${nm}</div>`;
    d.onclick=()=>{
      document.getElementById('bdgMT').textContent=nm;
      document.getElementById('bdgMI').innerHTML=getBadgeIcon(b.ic,u);
      document.getElementById('bdgMD').textContent=b.d;
      document.getElementById('bdgMS').innerHTML=u
        ?`<span style="color:var(--c)">‚úì ${TR[lang].unlocked}</span>`
        :`<span style="color:var(--tx2)">‚¨° ${TR[lang].locked}</span>`;
      openX('bdgM');
    };
    grid.appendChild(d);
  });
}
function fBadge(f){renderBadges(f)}

/* ‚îÄ‚îÄ WAKE LOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function requestWakeLock(){
  try{if('wakeLock'in navigator){wakeLock=await navigator.wakeLock.request('screen');document.getElementById('wlBanner').classList.remove('on');wakeLock.addEventListener('release',()=>{if(W.on&&!W.paused)document.getElementById('wlBanner').classList.add('on')});}else{document.getElementById('wlBanner').classList.add('on');}}catch(e){document.getElementById('wlBanner').classList.add('on');}
}
function releaseWakeLock(){if(wakeLock){wakeLock.release();wakeLock=null;}document.getElementById('wlBanner').classList.remove('on');}

/* ‚îÄ‚îÄ FIX #8 ‚Äî 3-RING TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function updRings(){
  // Ring 1 ‚Äî walk time (circ=578)
  const mn=W.el/60000;
  const r1p=Math.min(mn/(goals.minutes||30),1);
  document.getElementById('ring1').style.strokeDashoffset=578-578*r1p;
  // Ring 2 ‚Äî steps (circ=459)
  const r2p=Math.min(stepCount/(goals.steps||8000),1);
  document.getElementById('ring2').style.strokeDashoffset=459-459*r2p;
  // Ring 3 ‚Äî brainstorm (circ=339)
  const bsMn=bsElapsed/60000+(bsStart?((Date.now()-bsStart)/60000):0);
  const r3p=Math.min(bsMn/(goals.bsMins||30),1);
  document.getElementById('ring3').style.strokeDashoffset=339-339*r3p;
  // Update legend
  document.getElementById('leg1').textContent=Math.round(r1p*100)+'% cammino';
  document.getElementById('leg2').textContent=Math.round(r2p*100)+'% passi';
  document.getElementById('leg3').textContent=Math.round(r3p*100)+'% brain';
  // Pedometer goal display
  document.getElementById('pedoVal').textContent=stepCount;
  document.getElementById('pedoPb').style.width=Math.min(r2p*100,100)+'%';
}

/* ‚îÄ‚îÄ FIX #6 ‚Äî WALK PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function saveWalkState(){
  if(!W.on)return;
  localStorage.setItem('ms_walk_session',JSON.stringify({
    on:W.on,paused:W.paused,t0:W.t0,el:W.el,pt:W.pt,dist:W.dist,
    steps:stepCount,bsElapsed,bsStart,transcript,t:Date.now()
  }));
}
function restoreWalkSession(){
  const s=JSON.parse(localStorage.getItem('ms_walk_session')||'null');
  if(!s||!s.on)return false;
  const age=(Date.now()-s.t)/60000;
  if(age>60)return false; // non pi√π di 1 ora
  if(!confirm((lang==='en'?'Found incomplete session ':'Trovata sessione interrotta ')+'('+Math.round(age)+' min fa). '+(lang==='en'?'Restore?':'Ripristinare?')))return false;
  W={on:true,paused:true,t0:s.t0,el:s.el,pt:s.pt,dist:s.dist,lp:null,wid:null};
  stepCount=s.steps||0;bsElapsed=s.bsElapsed||0;
  transcript=s.transcript||'';
  document.getElementById('bsTA').value=transcript;
  document.getElementById('distV').textContent=W.dist.toFixed(2);
  W.paused=false;W.t0+=Date.now()-s.t;
  tInt=setInterval(tickW,1000);
  saveInt=setInterval(saveWalkState,30000);
  startGPS();startPedo();requestWakeLock();
  updWBtn();showEndBtn(true);
  return true;
}

function doWalk(){
  if(!W.on)startW();
  else if(!W.paused)pauseW();
  else resumeW();
}
function startW(){
  W={on:true,paused:false,t0:Date.now(),el:0,pt:0,dist:0,lp:null,wid:null};
  iShown={};stepCount=0;lastAccMag=0;lastStepTime=0;bsElapsed=0;bsStart=null;
  tInt=setInterval(tickW,1000);
  saveInt=setInterval(saveWalkState,30000);
  startGPS();startPedo();requestWakeLock();
  updWBtn();showEndBtn(true);
}
function pauseW(){
  W.paused=true;W.pt=Date.now();clearInterval(tInt);
  if(W.wid){navigator.geolocation.clearWatch(W.wid);W.wid=null;}
  stopPedo();releaseWakeLock();updWBtn();
  saveWalkState();
}
function resumeW(){
  W.paused=false;W.t0+=Date.now()-W.pt;
  tInt=setInterval(tickW,1000);
  startGPS();startPedo();requestWakeLock();updWBtn();
}
function showEndBtn(v){
  document.getElementById('endSessionBtn').style.display=v?'flex':'none';
}

/* FIX #6 ‚Äî Termina Sessione */
function endSession(){
  if(!confirm(lang==='en'?'End this WalkingBrain session?':'Terminare la sessione WalkingBrain?'))return;
  // Stop everything
  clearInterval(tInt);clearInterval(saveInt);tInt=null;
  if(W.wid){navigator.geolocation.clearWatch(W.wid);W.wid=null;}
  stopPedo();releaseWakeLock();
  if(recOn)stopRec();
  // Save to day
  const k=tod();let d=gd(k);
  d.walk={dist:W.dist,elapsed:W.el,steps:stepCount};
  d.brainstorm=transcript;
  d.bsTime=bsElapsed+(bsStart?(Date.now()-bsStart):0);
  sd(k,d);
  localStorage.removeItem('ms_walk_session');
  // Show summary
  const h=Math.floor(W.el/3600000),m=Math.floor((W.el%3600000)/60000);
  document.getElementById('sumKm').textContent=W.dist.toFixed(2);
  document.getElementById('sumSteps').textContent=stepCount;
  document.getElementById('sumTime').textContent=(h>0?h+'h ':'')+m+'min';
  document.getElementById('sumTitle').textContent=lang==='en'?'WalkingBrain complete!':'WalkingBrain completata!';
  openX('summaryM');
  // Reset state
  W={on:false,paused:false,t0:0,el:0,pt:0,dist:0,lp:null,wid:null};
  stepCount=0;bsElapsed=0;bsStart=null;
  document.getElementById('tDisp').textContent='00:00:00';
  document.getElementById('ring1').style.strokeDashoffset=578;
  document.getElementById('ring2').style.strokeDashoffset=459;
  document.getElementById('ring3').style.strokeDashoffset=339;
  updWBtn();showEndBtn(false);
  document.getElementById('strVal').textContent=calcStreak();
}

function startGPS(){
  if(!navigator.geolocation)return;
  navigator.geolocation.getCurrentPosition(p=>{
    W.lp={lat:p.coords.latitude,lng:p.coords.longitude};
    W.wid=navigator.geolocation.watchPosition(gUp,null,{enableHighAccuracy:true,maximumAge:1500});
  },null,{enableHighAccuracy:true});
}
function gUp(p){
  if(W.paused||!W.lp)return;
  const n={lat:p.coords.latitude,lng:p.coords.longitude};
  const d=hav(W.lp,n);
  if(d>0.005&&d<0.3){W.dist+=d;document.getElementById('distV').textContent=W.dist.toFixed(2);}
  W.lp=n;
}
function hav(a,b){const R=6371,dl=(b.lat-a.lat)*Math.PI/180,dn=(b.lng-a.lng)*Math.PI/180;const x=Math.sin(dl/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dn/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}

function tickW(){
  W.el=Date.now()-W.t0;
  const t=Math.floor(W.el/1000),h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;
  document.getElementById('tDisp').textContent=`${p2(h)}:${p2(m)}:${p2(s)}`;
  if(W.dist>0&&W.el>0){const hr=W.el/3600000;document.getElementById('spdV').textContent=(W.dist/hr).toFixed(1);}
  const u=JSON.parse(localStorage.getItem('ms_user')||'{}');
  document.getElementById('kcalV').textContent=Math.round(W.dist*(parseFloat(u.weight||70))*0.9);
  updRings();
  checkI(W.el/60000);
  // Brainstorm time display
  const bsT=bsElapsed+(bsStart?(Date.now()-bsStart):0);
  const bm=Math.floor(bsT/60000),bs2=Math.floor((bsT%60000)/1000);
  document.getElementById('bsTimeDisp').textContent=`${bm}:${p2(bs2)}`;
}
function p2(n){return String(n).padStart(2,'0')}
function updWBtn(){
  const btn=document.getElementById('wBtn'),t=document.getElementById('wBtnT');
  btn.style.cssText='';
  if(!W.on){btn.className='btn bp';t.textContent=lang==='en'?'Start WalkingBrain':'Inizia WalkingBrain';}
  else if(W.paused){btn.className='btn bs';t.textContent=lang==='en'?'Resume':'Riprendi';}
  else{btn.className='btn';btn.style.background='#f87171';btn.style.color='#fff';btn.style.border='none';t.textContent=lang==='en'?'Pause':'Pausa';}
  document.getElementById('walkStatus').textContent=W.on?(W.paused?'‚è∏ pausa':'‚óè live'):'';
}

/* ‚îÄ‚îÄ PEDOMETER (DeviceMotion) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function startPedo(){
  if(pedoActive)return;
  if(typeof DeviceMotionEvent==='undefined')return;
  const go=()=>{pedoActive=true;window.addEventListener('devicemotion',onMotion);};
  if(typeof DeviceMotionEvent.requestPermission==='function'){
    DeviceMotionEvent.requestPermission().then(r=>{if(r==='granted')go();}).catch(()=>{});
  }else{go();}
}
function stopPedo(){pedoActive=false;window.removeEventListener('devicemotion',onMotion);}
function onMotion(e){
  if(W.paused)return;
  const a=e.accelerationIncludingGravity;if(!a)return;
  const mag=Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2);
  const now=Date.now();
  if(mag>12&&lastAccMag<=12&&(now-lastStepTime)>300){stepCount++;lastStepTime=now;}
  lastAccMag=mag;
}

/* ‚îÄ‚îÄ INTROSPECTION (FIX #3 ‚Äî grande) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const INTR={
  it:[
    {m:5,msg:"C'√® un pensiero che ti appesantisce in questo momento? Nominalo e lascialo andare con il prossimo passo."},
    {m:15,msg:"Se questa sfida fosse un'opportunit√† travestita, cosa ti starebbe insegnando? Registra la risposta adesso."},
    {m:25,msg:"Smetti di cercare la soluzione perfetta. Qual √® la versione 'buona quanto basta' del tuo progetto?"},
    {m:40,msg:"Quando torni alla scrivania, qual √® la singola azione pi√π importante che puoi fare entro i prossimi 30 minuti?"}
  ],
  en:[
    {m:5,msg:"Is there a thought weighing you down right now? Name it and let it go with your next step."},
    {m:15,msg:"If this challenge were an opportunity in disguise, what would it be teaching you? Record your answer now."},
    {m:25,msg:"Stop searching for the perfect solution. What's the 'good enough' version of your project?"},
    {m:40,msg:"When you get back to your desk, what's the single most important action you can take in the next 30 minutes?"}
  ]
};
function checkI(mn){
  const pool=INTR[lang]||INTR.it;
  pool.forEach(t=>{
    if(mn>=t.m&&!iShown[t.m]){
      iShown[t.m]=true;
      document.getElementById('imsg').textContent=t.msg;
      document.getElementById('iTimeLabel').textContent=t.m+' min';
      document.getElementById('ibar').classList.add('on');
      if(navigator.vibrate)navigator.vibrate([100,50,100]);
      setTimeout(closeI,45000);
    }
  });
}
function closeI(){document.getElementById('ibar').classList.remove('on');}

/* ‚îÄ‚îÄ RECORDING (FIX #2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function doRec(){recOn?stopRec():startRec()}
function startRec(){
  if(!('webkitSpeechRecognition'in window)){alert(lang==='en'?'Use Chrome/Edge for voice recording.':'Usa Chrome o Edge per la registrazione.');return;}
  recO=new webkitSpeechRecognition();recO.continuous=true;recO.interimResults=true;
  recO.lang=lang==='en'?'en-US':'it-IT';
  bsStart=Date.now();
  recO.onstart=()=>{
    recOn=true;
    document.getElementById('rInd').classList.add('on');
    document.getElementById('recBtn').style.cssText='background:#f87171;color:#fff;';
    document.getElementById('recT').textContent=TR[lang].stop;
  };
  recO.onresult=e=>{
    interimT='';
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal){
        transcript+=e.results[i][0].transcript+' ';
        saveBsRaw(transcript);
      }else{interimT+=e.results[i][0].transcript;}
    }
    document.getElementById('bsTA').value=transcript+interimT;
  };
  recO.onerror=()=>stopRec();
  recO.onend=()=>{if(recOn)stopRec();};
  recO.start();
}
function stopRec(){
  recOn=false;
  if(bsStart){bsElapsed+=(Date.now()-bsStart);bsStart=null;}
  if(recO){recO.stop();recO=null;}
  document.getElementById('rInd').classList.remove('on');
  document.getElementById('recBtn').style.cssText='';
  document.getElementById('recT').textContent=TR[lang].record;
  saveBs();
}
function saveBs(){
  const txt=document.getElementById('bsTA').value;transcript=txt;saveBsRaw(txt);
}
function saveBsRaw(txt){const k=tod();let d=gd(k);d.brainstorm=txt;sd(k,d);}

/* ‚îÄ‚îÄ FIX #5 ‚Äî AI EXPORT: clipboard + open ‚îÄ‚îÄ */
function buildPrompt(){
  const n=document.getElementById('bsTA').value;
  if(!n.trim())return null;
  return (lang==='en'
    ?`Date: ${new Date().toLocaleDateString()}\nMy thoughts during the walk:\n"${n}"\n\nPlease help me:\n1. Identify the main themes\n2. Extract concrete action items\n3. Prioritize ideas by impact\n4. Suggest next steps for each\n5. Find any hidden insights`
    :`Data: ${new Date().toLocaleDateString()}\nI miei pensieri durante la camminata WalkingBrain:\n"${n}"\n\nAiutami a:\n1. Identificare i temi principali\n2. Estrarre action items concreti\n3. Prioritizzare le idee per impatto\n4. Suggerire prossimi passi\n5. Trovare insight nascosti`);
}
function sendAI(ai){
  const pr=buildPrompt();
  if(!pr){alert(lang==='en'?'No notes to export.':'Nessuna nota da esportare.');return;}
  // FIX #5: Clipboard first, then open URL
  if(navigator.clipboard){
    navigator.clipboard.writeText(pr).then(()=>{
      showToast(lang==='en'?'‚úì Copied! Paste in the chat.':'‚úì Copiato! Incollalo nella chat.');
    }).catch(()=>{});
  }
  const urls={
    claude:'https://claude.ai/new',
    chatgpt:'https://chatgpt.com',
    gemini:'https://gemini.google.com',
    copilot:'https://copilot.microsoft.com'
  };
  setTimeout(()=>window.open(urls[ai],'_blank'),600);
  closeX('exportM');
}
function expTxt(){
  const n=document.getElementById('bsTA').value;
  if(!n.trim()){alert(lang==='en'?'No notes.':'Nessuna nota.');return;}
  const b=new Blob([n],{type:'text/plain'});
  const url=URL.createObjectURL(b);const a=document.createElement('a');a.href=url;a.download=`mindstep_${tod()}.txt`;a.click();URL.revokeObjectURL(url);
  closeX('exportM');
}

/* ‚îÄ‚îÄ MUSIC LINKS (FIX #7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let pendingMusicUrl='';
function openMusicLink(url){
  pendingMusicUrl=url;
  if(recOn){
    document.getElementById('musicWarnTxt').textContent=lang==='en'
      ?'Opening this link may interrupt your active recording. Continue?'
      :'Aprire questo link potrebbe interrompere la registrazione. Continuare?';
    openX('musicWarnM');
  }else{window.open(url,'_blank','noopener');}
}
function confirmMusicLink(){closeX('musicWarnM');if(pendingMusicUrl)window.open(pendingMusicUrl,'_blank','noopener');pendingMusicUrl='';}
function opCus(){const u=document.getElementById('cusUrl').value.trim();if(!u)return;openMusicLink(u);}

/* ‚îÄ‚îÄ FIX #9 ‚Äî EXPORT CSV ONLY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function selRange(btn,days){document.querySelectorAll('.range-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');selectedRange=days;}
function expCSV(){
  const rows=['data,durata_hms,km,kcal,passi,routine_completate,min_brainstorm,trascrizione'];
  const u=JSON.parse(localStorage.getItem('ms_user')||'{}');const kg=parseFloat(u.weight||70);
  for(let i=0;i<selectedRange;i++){
    const d2=new Date();d2.setDate(d2.getDate()-i);
    const k=d2.toISOString().split('T')[0];const dt=gd(k);
    if(!dt||Object.keys(dt).length===0)continue;
    const km=(dt.walk?(dt.walk.dist||0):0).toFixed(2);
    const dur=dt.walk?(dt.walk.elapsed||0):0;
    const h=Math.floor(dur/3600000),m2=Math.floor((dur%3600000)/60000),s2=Math.floor((dur%60000)/1000);
    const durStr=`${p2(h)}:${p2(m2)}:${p2(s2)}`;
    const kcal=Math.round(parseFloat(km)*kg*0.9);
    const steps=dt.walk?(dt.walk.steps||0):0;
    const rdone=dt.routines?Object.values(dt.routines).filter(v=>v).length:0;
    const bsMin=dt.bsTime?Math.round(dt.bsTime/60000):0;
    const bs=(dt.brainstorm||'').replace(/"/g,'""').replace(/\n/g,' ');
    rows.push(`${k},${durStr},${km},${kcal},${steps},${rdone},${bsMin},"${bs}"`);
  }
  const csv=rows.join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');
  a.href=url;a.download=`mindstep_${tod()}_${selectedRange}d.csv`;a.click();
  URL.revokeObjectURL(url);closeX('exportAllM');
  showToast('‚úì CSV scaricato!');
}

/* ‚îÄ‚îÄ METEO (Open-Meteo, no key) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function loadWeather(force=false){
  if(!navigator.geolocation)return;
  const cached=JSON.parse(localStorage.getItem('ms_weather')||'null');
  if(cached&&!force&&(Date.now()-cached.ts)<900000){applyWeather(cached);return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const{latitude:lat,longitude:lon}=pos.coords;
    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&forecast_days=1`)
      .then(r=>r.json()).then(d=>{
        const cw=d.current_weather;if(!cw)return;
        const data={ico:wIcon(cw.weathercode,cw.is_day),tmp:Math.round(cw.temperature),cnd:wDesc(cw.weathercode),ts:Date.now()};
        localStorage.setItem('ms_weather',JSON.stringify(data));applyWeather(data);
      }).catch(()=>{});
  },()=>{},{timeout:5000});
}
function applyWeather(d){document.getElementById('wIco').textContent=d.ico;document.getElementById('wTmp').textContent=d.tmp+'¬∞';document.getElementById('wCnd').textContent=d.cnd;}
function wIcon(c,day){if(c===0)return day?'‚òÄÔ∏è':'üåô';if(c<=2)return'‚õÖ';if(c<=3)return'‚òÅÔ∏è';if(c<=48)return'üå´';if(c<=67)return'üåß';if(c<=77)return'‚ùÑÔ∏è';if(c<=82)return'üåß';if(c<=99)return'‚õà';return'üå°';}
function wDesc(c){if(c===0)return lang==='en'?'Clear':'Sereno';if(c<=2)return lang==='en'?'P.Cloudy':'P.Nuvolo';if(c<=3)return lang==='en'?'Overcast':'Coperto';if(c<=48)return lang==='en'?'Foggy':'Nebbia';if(c<=67)return lang==='en'?'Rain':'Pioggia';if(c<=77)return lang==='en'?'Snow':'Neve';if(c<=99)return lang==='en'?'Storm':'Temporale';return'';}

/* ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function goTab(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  document.getElementById('s-'+id).classList.add('on');
  document.getElementById('nt-'+id).classList.add('on');
  document.getElementById('mainArea').scrollTop=0;
  if(id==='achievements')renderBadges(badgeFilt);
  if(id==='stats'){renderWeek();renderGoalBars();}
  if(id==='calendar')renderCal();
}
function tog(bi,ci){document.getElementById(bi).classList.toggle('o');document.getElementById(ci).classList.toggle('o');}
function openX(id){
  // Populate goals modal before opening
  if(id==='goalsM'){
    document.getElementById('gStepsM').value=goals.steps;
    document.getElementById('gMinutesM').value=goals.minutes;
    document.getElementById('gSessionsM').value=goals.sessions;
    document.getElementById('gBsMinsM').value=goals.bsMins;
  }
  document.getElementById(id).classList.add('on');
}
function closeX(id){document.getElementById(id).classList.remove('on');}
window.addEventListener('click',e=>{document.querySelectorAll('.modal.on').forEach(m=>{if(e.target===m)m.classList.remove('on');});});

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function showToast(msg,dur=2500){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('on');
  setTimeout(()=>t.classList.remove('on'),dur);
}

/* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let sR=[];
function saveProfile(){
  const n=document.getElementById('uName').value.trim();
  if(!n){alert(lang==='en'?'Enter your name.':'Inserisci il nome.');return;}
  localStorage.setItem('ms_user',JSON.stringify({name:n,age:document.getElementById('uAge').value,gender:document.getElementById('uGender').value,weight:document.getElementById('uWeight').value,lang,created:new Date().toISOString()}));
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  document.getElementById('s-goals').classList.add('on');
}
function saveGoals(){
  goals={
    steps:parseInt(document.getElementById('gSteps').value)||8000,
    minutes:parseInt(document.getElementById('gMinutes').value)||30,
    sessions:parseInt(document.getElementById('gSessions').value)||2,
    bsMins:parseInt(document.getElementById('gBsMins').value)||30
  };
  localStorage.setItem('ms_goals',JSON.stringify(goals));
  document.getElementById('goalStepsDisp').textContent=goals.steps;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  document.getElementById('s-routines').classList.add('on');
  updRC();
}
function saveGoalsModal(){
  goals={
    steps:parseInt(document.getElementById('gStepsM').value)||8000,
    minutes:parseInt(document.getElementById('gMinutesM').value)||30,
    sessions:parseInt(document.getElementById('gSessionsM').value)||2,
    bsMins:parseInt(document.getElementById('gBsMinsM').value)||30
  };
  localStorage.setItem('ms_goals',JSON.stringify(goals));
  document.getElementById('goalStepsDisp').textContent=goals.steps;
  closeX('goalsM');
  showToast(lang==='en'?'‚úì Goals saved!':'‚úì Obiettivi salvati!');
}
function addRSetup(){
  if(sR.length>=10)return;sR.push('');const i=sR.length-1;
  const l=document.getElementById('rSetupList'),row=document.createElement('div');
  row.className='rsi';row.dataset.i=i;
  row.innerHTML=`<input type="text" placeholder="${lang==='en'?'E.g. Meditation':'Es. Meditazione'}" maxlength="40" oninput="sR[${i}]=this.value"><button class="delbtn" onclick="delRS(${i})">√ó</button>`;
  l.appendChild(row);updRC();
  if(sR.length>=10)document.getElementById('addRBtn').style.opacity='.4';
}
function delRS(i){document.querySelector(`.rsi[data-i="${i}"]`)?.remove();sR.splice(i,1);updRC();document.getElementById('addRBtn').style.opacity='1';}
function updRC(){document.getElementById('rCount').textContent=sR.length+'/10';}
function saveRSetup(){
  routines=Array.from(document.querySelectorAll('#rSetupList input[type=text]')).map(i=>i.value.trim()).filter(v=>v);
  if(!routines.length&&!confirm(lang==='en'?'No routines. Continue?':'Nessuna routine. Continuare?'))return;
  localStorage.setItem('ms_routines',JSON.stringify(routines));
  loadApp();
}

/* ‚îÄ‚îÄ ROUTINES (FIX #2 + FIX #5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderR(){
  const list=document.getElementById('rList');list.innerHTML='';
  routines=JSON.parse(localStorage.getItem('ms_routines')||'[]');
  if(!routines.length){list.innerHTML=`<p style="text-align:center;padding:14px;font-size:13px;color:var(--tx2)">${lang==='en'?'Go to More ‚Üí Edit Routines':'Vai in Altro ‚Üí Modifica Routine'}</p>`;updProg(0,0);return;}
  const k=tod(),d=gd(k);
  routines.forEach((r,i)=>{
    const done=!!(d.routines&&d.routines[i]);
    const el=document.createElement('div');el.className='ri'+(done?' done':'');
    el.innerHTML=`<input type="checkbox" id="ri${i}" ${done?'checked':''} onchange="chkR(${i})"><label class="ri-l" for="ri${i}">${r}</label>`;
    list.appendChild(el);
  });
  const done=d.routines?routines.filter((_,i)=>d.routines[i]).length:0;
  updProg(done,routines.length);
}
function chkR(i){
  const k=tod();let d=gd(k);d.routines=d.routines||{};
  d.routines[i]=document.getElementById('ri'+i).checked;sd(k,d);
  document.getElementById('ri'+i).parentElement.classList.toggle('done',d.routines[i]);
  const done=routines.filter((_,j)=>d.routines&&d.routines[j]).length;
  updProg(done,routines.length);
}
function updProg(done,total){
  const pct=total>0?Math.round(done/total*100):0;
  document.getElementById('rSum').textContent=`${done}/${total}`;
  document.getElementById('pBar').style.width=pct+'%';
  document.getElementById('pPct').textContent=pct+'%';
}

/* FIX #2: Edit routine durante sessione ‚Äî preserva completamento per indice */
function openEditR(){
  const list=document.getElementById('eRList');list.innerHTML='';
  routines.forEach((r,i)=>{
    const row=document.createElement('div');row.className='rsi';
    row.innerHTML=`<input type="text" value="${r}" maxlength="40"><button class="delbtn" onclick="this.parentElement.remove()">√ó</button>`;
    list.appendChild(row);
  });
  openX('editRM');
}
function addER(){
  const l=document.getElementById('eRList');if(l.children.length>=10)return;
  const row=document.createElement('div');row.className='rsi';
  row.innerHTML=`<input type="text" placeholder="${lang==='en'?'New routine...':'Nuova routine...'}" maxlength="40"><button class="delbtn" onclick="this.parentElement.remove()">√ó</button>`;
  l.appendChild(row);
}
function saveER(){
  const newR=Array.from(document.querySelectorAll('#eRList input[type=text]')).map(i=>i.value.trim()).filter(v=>v);
  // FIX #2: Preserva stato completamento per indice corrispondente
  const k=tod();let d=gd(k);
  if(d.routines){
    const newComp={};
    newR.forEach((nr,ni)=>{
      // Trova se esiste la stessa routine nella lista vecchia
      const oi=routines.indexOf(nr);
      if(oi>=0&&d.routines[oi]!==undefined){newComp[ni]=d.routines[oi];}
    });
    d.routines=newComp;sd(k,d);
  }
  routines=newR;
  localStorage.setItem('ms_routines',JSON.stringify(routines));
  closeX('editRM');renderR();
}

/* ‚îÄ‚îÄ GOAL BARS (stats) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderGoalBars(){
  const d=gd(tod());
  const walkMin=d.walk?Math.round(d.walk.elapsed/60000):0;
  const walkSteps=d.walk?(d.walk.steps||0):0;
  const bsMin=d.bsTime?Math.round(d.bsTime/60000):0;
  const routDone=d.routines?Object.values(d.routines).filter(v=>v).length:0;
  const bars=[
    {label:'Minuti cammino',val:walkMin,goal:goals.minutes,color:'var(--ring1)',unit:'min'},
    {label:'Passi',val:walkSteps,goal:goals.steps,color:'var(--ring2)',unit:''},
    {label:'Brainstorming',val:bsMin,goal:goals.bsMins,color:'var(--ring3)',unit:'min'},
    {label:'Routine',val:routDone,goal:routines.length||1,color:'var(--c)',unit:''}
  ];
  document.getElementById('goalBars').innerHTML=bars.map(b=>{
    const pct=Math.min(Math.round(b.val/(b.goal||1)*100),100);
    return`<div class="gbar-row">
      <div class="gbar-info">
        <div class="gbar-label"><span>${b.label}</span><span class="gbar-val">${b.val}/${b.goal}${b.unit}</span></div>
        <div class="gbar-track"><div class="gbar-fill" style="width:${pct}%;background:${b.color}"></div></div>
      </div>
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ WEEKLY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderWeek(){
  const g=document.getElementById('wGrid');g.innerHTML='';
  const dn=lang==='en'?['Su','Mo','Tu','We','Th','Fr','Sa']:['D','L','M','M','G','V','S'];
  const s=new Date();s.setDate(s.getDate()-s.getDay());
  let a=0,km=0,tR=0,dR=0;
  for(let i=0;i<7;i++){
    const dd=new Date(s);dd.setDate(s.getDate()+i);
    const k=dd.toISOString().split('T')[0],dt=gd(k);
    const h=(dt.routines&&Object.values(dt.routines).some(v=>v))||dt.walk;
    if(h)a++;
    if(dt.walk)km+=dt.walk.dist||0;
    routines.forEach((_,idx)=>{if(dt.routines&&dt.routines.hasOwnProperty(idx)){tR++;if(dt.routines[idx])dR++;}});
    const c=document.createElement('div');c.className='day'+(h?' on':'');
    c.innerHTML=`<div class="dn">${dn[i]}</div><div>${h?'‚úì':'¬∑'}</div>`;
    c.onclick=()=>showToast(`${dd.toLocaleDateString()} ‚Äî ${dt.walk?(dt.walk.dist||0).toFixed(1)+' km':'‚Äî'}`);
    g.appendChild(c);
  }
  document.getElementById('wDays').textContent=`${a}/7`;
  document.getElementById('wKm').textContent=km.toFixed(1);
  document.getElementById('wRout').textContent=(tR>0?Math.round(dR/tR*100):0)+'%';
}

/* ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderCal(){
  const card=document.getElementById('calCard');
  const keys=Object.keys(localStorage).filter(k=>k.startsWith('ms_day_'));
  if(!keys.length){card.innerHTML=`<div class="empty"><svg viewBox="0 0 24 24" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg><h3>${lang==='en'?'No data':'Nessun dato'}</h3><p>${lang==='en'?'Complete your first WalkingBrain.':'Completa la prima sessione WalkingBrain.'}</p></div>`;return;}
  card.innerHTML=keys.sort().reverse().map(k=>{
    const d=JSON.parse(localStorage.getItem(k));const dt=k.replace('ms_day_','');
    const dn=d.routines?Object.values(d.routines).filter(v=>v).length:0;
    const ds=d.walk?(d.walk.dist||0).toFixed(1):'0';
    const steps=d.walk?(d.walk.steps||0):0;
    const bsM=d.bsTime?Math.round(d.bsTime/60000):0;
    return`<div style="padding:12px 14px;border-bottom:1px solid var(--bdr);display:flex;justify-content:space-between;align-items:center">
      <div><div style="font-size:13px;font-weight:700">${dt}</div><div style="font-size:10px;color:var(--tx2);margin-top:2px">${dn} routine ¬∑ ${bsM} min brain</div></div>
      <div style="display:flex;gap:14px;font-size:12px">
        <span style="color:var(--ring1);font-weight:700">${ds} km</span>
        <span style="color:var(--ring2);font-weight:700">${steps} passi</span>
      </div>
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function setTh(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('ms_theme',t);['light','auto','dark'].forEach(x=>document.getElementById('th-'+x).classList.remove('on'));document.getElementById('th-'+t).classList.add('on');}
function doEditPro(){
  const u=JSON.parse(localStorage.getItem('ms_user')||'{}');
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  document.getElementById('s-welcome').classList.add('on');
  document.getElementById('uName').value=u.name||'';document.getElementById('uAge').value=u.age||'';document.getElementById('uGender').value=u.gender||'';document.getElementById('uWeight').value=u.weight||'';
}
function resetAll(){if(confirm(lang==='en'?'Delete ALL data?':'Cancellare TUTTI i dati?')&&confirm(lang==='en'?'Confirm.':'Conferma.')){localStorage.clear();location.reload();}}

/* ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function tod(){return new Date().toISOString().split('T')[0];}
function gd(k){return JSON.parse(localStorage.getItem('ms_day_'+k)||'{}');}
function sd(k,d){localStorage.setItem('ms_day_'+k,JSON.stringify(d));}
function calcStreak(){let s=0;const d=new Date();d.setHours(0,0,0,0);for(let i=0;i<365;i++){const k=new Date(d.getTime()-i*86400000).toISOString().split('T')[0];const dt=gd(k);if((dt.routines&&Object.values(dt.routines).some(v=>v))||dt.walk)s++;else break;}return s;}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function loadApp(){
  const u=JSON.parse(localStorage.getItem('ms_user')||'null');
  routines=JSON.parse(localStorage.getItem('ms_routines')||'[]');
  goals=JSON.parse(localStorage.getItem('ms_goals')||JSON.stringify(goals));
  if(!u){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));document.getElementById('s-welcome').classList.add('on');return;}
  document.getElementById('brandN').textContent=u.name||'MindStep';
  document.getElementById('strVal').textContent=calcStreak();
  document.getElementById('goalStepsDisp').textContent=goals.steps;
  renderR();loadQuote();goTab('home');
  restoreWalkSession();
}
function init(){
  lang=localStorage.getItem('ms_lang')||'it';
  setLang(lang);
  const t=localStorage.getItem('ms_theme')||'auto';setTh(t);
  loadApp();loadWeather();
  if('serviceWorker'in navigator)navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  console.log('MindStep v'+VER+' ‚Äî AI Walking Intelligence ‚Äî 9 fixes applied');
}
init();
</script>
</body>
</html>
